<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FORCAST Grism Spectra: Basic Inspection and Assessment &mdash; SOFIA tutorials  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="FORCAST Grism Spectra: Basic Line Analysis" href="FORCAST-Grism_LineAnalysis-2.html" />
    <link rel="prev" title="FORCAST photometry (detailed)" href="FORCAST-photometry_detailed.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> SOFIA tutorials
            <img src="_static/sofia_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Python Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="FORCAST-Basic_Photometry.html">FORCAST Basic photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="FORCAST-photometry_detailed.html">FORCAST photometry (detailed)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">FORCAST Grism Spectra: Basic Inspection and Assessment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Goals">Goals</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Imports">Imports</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Ingredients">Ingredients</a></li>
<li class="toctree-l2"><a class="reference internal" href="#FORCAST-data">FORCAST data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Viewing-the-FITS-Header">Viewing the FITS Header</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Slit-Orientation-on-the-Sky">Slit Orientation on the Sky</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Reading-the-File-and-Loading-the-Data-into-a-Table-Structure">Reading the File and Loading the Data into a Table Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Plotting-the-Spectra">Plotting the Spectra</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Masking-Regions-with-Strong-Telluric-Features">Masking Regions with Strong Telluric Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Plotting-the-Complete-SED">Plotting the Complete SED</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Calibration-Using-Independant-Photometry">Calibration Using Independant Photometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Converting-to-\lambdaF_{\lambda}">Converting to <span class="math notranslate nohighlight">\(\lambda\)</span>F<span class="math notranslate nohighlight">\(_{\lambda}\)</span></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="FORCAST-Grism_LineAnalysis-2.html">FORCAST Grism Spectra: Basic Line Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="FORCAST-Grism_CustomExtraction-3.html">FORCAST Grism Spectra: Custom Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="HAWC_30_Dor.html">HAWC+ Data Recipe / 30 Doradus Data Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="EXES-Data-Inspection.html">EXES: Data inspection</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="SOFIA_data_retrieval.html">SOFIA data retrieval</a></li>
<li class="toctree-l1"><a class="reference internal" href="FIFI-LS_sospex.html">FIFI-LS: Basic Cube Analysis using SOSPEX</a></li>
<li class="toctree-l1"><a class="reference internal" href="GREAT-Class_primer.html">GREAT: Class primer</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SOFIA tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>FORCAST Grism Spectra: Basic Inspection and Assessment</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/FORCAST-Grism_Inspection-1.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="FORCAST-Grism-Spectra:-Basic-Inspection-and-Assessment">
<h1>FORCAST Grism Spectra: Basic Inspection and Assessment<a class="headerlink" href="#FORCAST-Grism-Spectra:-Basic-Inspection-and-Assessment" title="Permalink to this headline"></a></h1>
<ul class="simple">
<li><p><strong>Aim</strong>: Inspection of grism data.</p></li>
<li><p><strong>Data</strong>: Level 3 grism data of the Herbig Ae star, AB Aur (G063, G111, G227, and G329)</p></li>
<li><p><strong>Tools</strong>: astropy, DS9</p></li>
<li><p><strong>Instrument</strong>: FORCAST</p></li>
<li><p><strong>Documentation</strong>: <a class="reference external" href="https://www.sofia.usra.edu/sites/default/files/USpot_DCS_DPS/Documents/FORCAST_data_handbook.pdf">FORCAST data handbook</a></p></li>
<li><p><strong>Notebook repository</strong>: <a class="reference external" href="https://github.com/SOFIAObservatory/Recipes">https://github.com/SOFIAObservatory/Recipes</a></p></li>
</ul>
<section id="Goals">
<h2>Goals<a class="headerlink" href="#Goals" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>Read and inspect FORCAST grism data.</p></li>
<li><p>Overplot slit angle and position on image using DS9.</p></li>
<li><p>Masking regions with strong telluric features.</p></li>
<li><p>Plot Spectral Energy Distribution (SED).</p></li>
<li><p>Absolute flux calibration using independant photometry.</p></li>
<li><p>Conversion of flux from Jy to <span class="math notranslate nohighlight">\(\lambda\)</span>F<span class="math notranslate nohighlight">\(_{\lambda}\)</span>.</p></li>
</ul>
</section>
<section id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this headline"></a></h2>
<p>This recipe provides an overview and sample python code for plotting and assessing FORCAST grism data. The FORCAST observing modes are described in the SOFIA Observer’s Handbooks, available from the <a class="reference external" href="https://www.sofia.usra.edu/researchers/proposing-and-observing">Proposing and Observing page on the SOFIA website</a>; and the FORCAST data products are described in the <a class="reference external" href="https://www.sofia.usra.edu/sites/default/files/USpot_DCS_DPS/Documents/FORCAST_data_handbook.pdf">FORCAST GO Data Handbook</a>.</p>
</section>
<section id="Imports">
<h2>Imports<a class="headerlink" href="#Imports" title="Permalink to this headline"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># for interactive plots</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</section>
<section id="Ingredients">
<h2>Ingredients<a class="headerlink" href="#Ingredients" title="Permalink to this headline"></a></h2>
<ol class="arabic simple">
<li><p>Level 3 (flux calibrated) FORCAST grism data (either CAL or CMB files) from the Infrared Science Archive (<a class="reference external" href="https://irsa.ipac.caltech.edu/Missions/sofia.html">IRSA</a>)</p></li>
<li><p>Sample Data (if desired): For the examples in this recipe, we use the calibrated data for AB Aur from program 05_0138 (PI: Shuping), flight 434. The dataset consists of four LEVEL 3 CMB files, one file for each grism setting (G063, G111, G227, and G329), which can be downloaded from the IRSA using the following search parameters: - Coordinates or Object Name = AB Aur - Radius = 100 arcseconds - MissionID = 2017-09-27_FO_F434 - PlanID = 05_0138 - Instrument = FORCAST - Configuration = Low
Resolution Spectroscopy - Processing State = LEVEL 3 The four files should be saved with their original names in a folder named “forcast-sample-data” in the same directory as this Python Notebook: - forcast-sample-data/F0434_FO_GRI_0501381_FORG063_CMB_0228-0229.fits - forcast-sample-data/F0434_FO_GRI_0501382_FORG111_CMB_0234-0238.fits - forcast-sample-data/F0434_FO_GRI_0501383_FORG227_CMB_0230-0233.fits - forcast-sample-data/F0434_FO_GRI_0501384_FORG329_CMB_0239-0246.fits <strong>You can download
the example data directly</strong><a class="reference external" href="https://zenodo.org/record/5706312/files/FORCAST-Grism_Inspection-example-data.zip?download=1">here</a>.</p></li>
<li><p><a class="reference external" href="https://www.sofia.usra.edu/sites/default/files/USpot_DCS_DPS/Documents/FORCAST_data_handbook.pdf">FORCAST GO Handbook</a> for reference (latest version can be found on the <a class="reference external" href="https://www.sofia.usra.edu/data/data-processing-0#DataHandbooks">SOFIA Data Products</a> page.)</p></li>
</ol>
</section>
<section id="FORCAST-data">
<h2>FORCAST data<a class="headerlink" href="#FORCAST-data" title="Permalink to this headline"></a></h2>
<p>Raw FORCAST data suffers from several instrumental artifacts. Nearly all of the artifacts are removed or corrected by the FORCAST pipeline, including: bad pixels; the Droop effect; non-linear pixel response; and the “jailbar” effect. In addition, the grism pipeline extracts the one-dimensional spectra, applies both wavelength and flux calibration, and corrects for telluric absorption. For point sources, an “optimal extraction” algorithm is used, while for extended (non-point-like) sources, a
standard summation over a fixed aperture is used (see recipe on custom extractions for additional information). See the <a class="reference external" href="https://www.sofia.usra.edu/sites/default/files/USpot_DCS_DPS/Documents/FORCAST_data_handbook.pdf">FORCAST GO Data Handbook</a> for details regarding the artifacts, pipeline algorithms, and the flux-calibration process.</p>
<p>Level 3 FORCAST grism data is written in FITS format as a 2-dimensional data array with a single header (for detailed description, see FORCAST GO Data Handbook). The data is in a 5 x N array, where N is the number of wavelength bins/samples, with the following convention: - The first line of the data array contains the wavelength (<span class="math notranslate nohighlight">\(\mu\)</span>m); - the second line contains the pipeline-reduced and flux calibrated spectrum (Jy); - the third line contains the uncertainty (Jy); - the fourth
contains the adopted atmospheric transmission spectrum; - and the fifth contains the instrumental response used in the flux calibration process (Me-/s/Jy, where “Me-” is 10^6 electrons).</p>
<p>Each FORCAST grism file contains the spectrum for a specific grism, which is indicated in the name of the file, e.g. “FORG111” would be a file containing data for the 11.1 <span class="math notranslate nohighlight">\(\mu\)</span>m grism. The pipeline does <em>not</em> combine specta from different grisms, this is left to the user.</p>
<p>There are two data types for LEVEL 3 FORCAST grism data: 1. CAL files: flux calibrated results for each raw (LEVEL_1) data file. There can be multiple CAL files for a single AOR. 2. CMB files: if possible, multiple CAL files for a single AOR are coadded into a “combined” data file. Usually there is only one CMB file per AOR.</p>
<p>Except for the provenance, the two datatypes are identical and hence the procedures below are equally valid for both.</p>
<p>The “error” spectrum is for the statistical uncertainty <em>only</em> and does not reflect systematic uncertainties in the absolute flux, for example losses due to slit misalignment or poor image quality (see below). If absolute fluxes are required, it is highly recommended that additional imaging data are obtained at the same time in order to calibrate the grism spectra accurately.</p>
</section>
<section id="Viewing-the-FITS-Header">
<h2>Viewing the FITS Header<a class="headerlink" href="#Viewing-the-FITS-Header" title="Permalink to this headline"></a></h2>
<p>First we will read a FITS file for one of the grism observations, display the full header, and then pick out some important keyword values to display in a “summary” table.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># first open the file...</span>
<span class="n">g063_fits</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../example_data/FORCAST/F0434_FO_GRI_0501381_FORG063_CMB_0228-0229.fits&quot;</span><span class="p">)</span>
<span class="c1"># ...and get info</span>
<span class="n">g063_fits</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Filename: ../example_data/FORCAST/F0434_FO_GRI_0501381_FORG063_CMB_0228-0229.fits
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU     324   (242, 5)   float64
</pre></div></div>
</div>
<p>You can see from the FITS file info that the file contains a single primary HDU with 5 x 242 element array containing the calibrated data. Now display the full header:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Now display FITS header in full:</span>
<span class="n">g063_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">30</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
SIMPLE  =                    T / Written by IDL:  Wed Nov 22 15:43:45 2017
BITPIX  =                  -64 /Real*8 (double precision)
NAXIS   =                    2 /
NAXIS1  =                  242 /
NAXIS2  =                    5 /
ALTI_STA=                42984 / feet, aircraft altitude start das.ic1080_15hz.p
ALTI_END=                42993 / feet, aircraft altitude end das.ic1080_15hz.pre
AOR_ID  = &#39;05_0138_1&#39;          / Astronomical Observation Request Identifier
ASSC_AOR= &#39;05_0138_1&#39;          / All input AOR-IDs
ATRNFILE= &#39;ATRAN_Models/atran_43K_35deg_4-50mum.sav&#39; / ATRAN file
CALERR  =            0.0237970 / Fractional flux calibration error
C2NC2   =                    F / pointing controlled without telescope nod
CHOPPING=                    T / chopping
CHPAMP1 =                   30 / arcsec, chop amplitude on sky sma.sky_amplitude
CHPANGLE=                 -330 / deg, chop angle astro commanded (e.g. aor)
CHPANGLR=                  330 / deg, chop angle requested of the obervatory
CHPCOORD=                    0 / 0=SIRF 1=TARF 2=ERF
CHPNPOS =                    2 / number of secondary mirror (chop) positions
CHPSETL =                   26 / milliseconds allotted for chopper settle
DATASRC = &#39;astro   &#39;           / (DCS) data source
DATE-OBS= &#39;2017-09-27T09:03:58.606&#39; / observation start ccyy-mm-ddThh:mm:ss.s
DETBIAS =              1.73700 / detector bias
DETCHAN = &#39;SW      &#39;           / wavelength channel swc lwc
DETECTOR= &#39;As-010  &#39;           / detector array
DETITIME=              17.9601 / detector integration time, discounts throwaways
DICHROIC= &#39;Mirror (swc)&#39;       / dichroic element
DITHER  =                    F / dithers are in use
EPERADU =                  136 / electrons per DN
FILENUM = &#39;0228-0229&#39;          /
FILTER  = &#39;G5-8    &#39;           / filter configuration name
</pre></div></div>
</div>
<p>The header is quite large, so we might want to just pull out some keywords of interest:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># And now pull out useful summary data from specific keywords:</span>
<span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;ALTI_STA&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ALTI_END&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AOR_ID &quot;</span><span class="p">,</span>
    <span class="s2">&quot;CHPAMP1 &quot;</span><span class="p">,</span>
    <span class="s2">&quot;DATE-OBS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MISSN-ID  &quot;</span><span class="p">,</span>
    <span class="s2">&quot;NODAMP  &quot;</span><span class="p">,</span>
    <span class="s2">&quot;OBJECT &quot;</span><span class="p">,</span>
    <span class="s2">&quot;SKY_ANGL &quot;</span><span class="p">,</span>
    <span class="s2">&quot;SKYMODE  &quot;</span><span class="p">,</span>
    <span class="s2">&quot;SLIT    &quot;</span><span class="p">,</span>
    <span class="s2">&quot;ZA_START  &quot;</span><span class="p">,</span>
    <span class="s2">&quot;ZA_END  &quot;</span><span class="p">,</span>
    <span class="s2">&quot;TELVPA  &quot;</span><span class="p">,</span>
    <span class="s2">&quot;NODSTYLE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TOTINT    &quot;</span><span class="p">,</span>
    <span class="s2">&quot;CALQUAL   &quot;</span><span class="p">,</span>
    <span class="s2">&quot;WCSQUAL     &quot;</span><span class="p">,</span>
    <span class="s2">&quot;DATAQUAL&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Loop over keywords to print.</span>
<span class="k">for</span> <span class="n">kywd</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">kywd</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="n">g063_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">kywd</span><span class="p">],</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">g063_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="n">kywd</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ALTI_STA = 42984 / feet, aircraft altitude start das.ic1080_15hz.p
ALTI_END = 42993 / feet, aircraft altitude end das.ic1080_15hz.pre
AOR_ID  = 05_0138_1 / Astronomical Observation Request Identifier
CHPAMP1  = 30 / arcsec, chop amplitude on sky sma.sky_amplitude
DATE-OBS = 2017-09-27T09:03:58.606 / observation start ccyy-mm-ddThh:mm:ss.s
MISSN-ID   = 2017-09-27_FO_F434 / mission id
NODAMP   = 60 / arcsec nod amplitude
OBJECT  = AB Aur (1) / name given by observer
SKY_ANGL  = 261.527 / &#34;up&#34; on det from N, coords.pos.sibs.vpa
SKYMODE   = NMC / sky patterning mode
SLIT     = FOR_LS47 / slit
ZA_START   = 35.3101 / zenith angle soo 90-coord.pos.sibs.alt
ZA_END   = 34.9659 / zenith angle eoo
TELVPA   = 261.527 / deg, SI VPA coord.pos.sibs_vpa
NODSTYLE = NMC / nod/chop style
TOTINT     = 71.8406 / Total integration time (s) as specified in the
CALQUAL    = NOMINAL / Calibration status
WCSQUAL      = UNKNOWN / WCS validity
DATAQUAL = NOMINAL / QA status: see HISTORY
</pre></div></div>
</div>
<p>This list of keywords provides a nice summary of the observation. There are a few different keywords in the header for integration time(s); here we show TOTINT because it reflects the total on-source integration time (factoring in chop-nod style). This is the value that the GO should use to compare to the FORCAST integration time estimator. It is also important to take a look at the HISTORY cards to see a summary of the data pipelining and especially the QA notes, which are usually at the end of
the HISTORY block:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Display HISTORY block:</span>
<span class="nb">print</span><span class="p">(</span><span class="n">g063_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HISTORY&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


Previous History
----------------


Headers updated by dsandel, 2017-09-29T10:40:42
WCSQUAL: None -&gt; UNKNOWN

---------------------------------------
---------- PIPELINE HISTORY -----------
---------------------------------------

:::::::::::::::::::::::::::::::::::::
::: LOAD DATA, CALCULATE VARIANCE :::
Read noise is 244.800
Excess noise factor is 1.00000
Gain is 136.000
Integration time is 8.98005
Variance for raw data calculated from
V = N*betaG/(FR*t*g) + RN^2/(FR*t*g^2), where
N is the raw ADU per frame in each pixel,
betaG is the excess noise factor,
FR is the frame rate, t is the integration time,
g is the gain, and RN is the
read noise in electrons

::::::::::::::::::::::::
::: CLEAN BAD PIXELS :::
Clean: Jailbar cleaning method is MEDIAN
Interpolate using maskinterp(data,mask,1,6,plsfit)
Clean: Remove corrupted line 255 - Replaced with 254

::::::::::::::::::::::::
::: DROOP CORRECTION :::
Droop: Applied channel suppression (droop) correction
Droop: Channel suppression correction factor 0.00350000

::::::::::::::::::::::::::::::::::::
::: BACKGROUND LEVEL CALCULATION :::
Background: level is 2465.10,2464.78,2453.95,2453.92 using
section defi
::: IMG NON-LINEARITY CORRECTION :::
Image non-linearity: Scale is 6000.00
Coeff=[0.99762921,0.34382635,-0.019972477,-0.040238521,-0.169616
7,0.08
Image non-linearity: level limits are [1926.0, 11905.0]
Image non-linearity: factor of plane 0 is 0.770196
Image non-linearity: factor of plane 1 is 0.770169
Image non-linearity: factor of plane 2 is 0.769242
Image non-linearity: factor of plane 3 is 0.769239

::::::::::::::::
::: STACKING :::
Counts converted to millions of e/s using
FRMRATE=29.9192 and EPERADU=136
Value of chop tsa convention is -1


-----------------------------------------------------------

This file produced by FORCAST_REDUX v1.3.0 with reduction
package(s):
FSPEXTOOL v1.4.0 (for extraction)
DRIP v1.1.7 (for image processing)

FSpextool History
-----------------

Input ObsIDs: 2017-09-27_FO_F434B0228, 2017-09-27_FO_F434B0229

Description of reduction:
This spectrum was extracted from
F0434_FO_GRI_0501381_FORG063_STK_0228.fits,F0434_FO_GRI_0501381_
ORG063_STK_0229.fits.  The flat
OC2cals/spatcal_20150217/G1_wide_flat.fits was used to find the
edges of the order in the extraction process.  The image and
flat were used to define smoothed spatial profiles.  These
profiles were used to determine aperture centers and radii.
Background regions were determined, fit, and subtracted from the
spectra during extraction.  The wavecal file
OC2cals/spatcal_20150217/G1_wavecal.fits was used to determine
the wavelength calibration.  The spectra were extracted using
standard extraction.  Bad pixels were fixed during extraction.
Extracted spectral orders were scaled by the factors 0.986,
1.014.  Spectra from all apertures in all input images were
combined using a Median (MAD) statistic.

Description of data:
The output FITS files contain a 3-D array of data consisting of
sets of triplet arrays of data for each aperture and each order,
where each triplet is composed of an array for the wavelength,
an array for the flux, and an array for the error. The triplets
for each aperture are stacked behind one another, followed by
the triplets for the next order, etc. If no orders have been
skipped or deselected in the extraction process, the contents of
aperture Y in order X can be found as follows:lambda =
array[*,0,( X - (smallest order number))*naps + (Y-1)], flux   =
array[*,1,( X - (smallest order number))*naps + (Y-1)], error  =
array[*,2,( X - (smallest order number))*naps + (Y-1)]  For
example, for an SXD file with two apertures, the wavelength
array for aperture 1 in order 3 is located in array [*,0,0], the
flux is in array [*,1,0] and the error is in array [*,2,0]. For
aperture 2, the wavelength is in array [*,0,1], the flux is in
array [*,1,1] and the error is in array [*,2,1]. For order 4,
the flux for aperture 1 is in array [*,1,2], while the flux for
aperture 2 is in array [*,1,3]. For order 5, the fluxes for the
two apertures are in arrays [*,1,4] and [*,1,5], etc.

Additional processing:
The spectra were shifted in wavelength by 0.49159486,0.61216746
pixels to match the atmospheric model.The spectra were
calibrated by dividing by the atmospheric transmission model
(ATRAN_Models/atran_43K_35deg_4-50mum.sav) and the instrumental
response (response/v4.1.0/G063_LS47_DB175_response.fits). These
models are recorded in the spectra as columns 4 and 5,
respectively.

-----------------------------------------------------------

This file produced by FORCAST_REDUX v1.3.0 with reduction
package(s):
  FSPEXTOOL v1.4.1 (for extraction)
  DRIP v1.1.7 (for image processing)

Headers updated by sshenoy, 2017-11-24T09:34:12

Notes from quality analysis
---------------------------
Telluric correction optimization failed. Default atran model was
used to perform telluric correction.

  CALQUAL: None -&gt; NOMINAL
  WCSQUAL: None -&gt; UNKNOWN
  DATAQUAL: None -&gt; NOMINAL

</pre></div></div>
</div>
<p>So in this case, manual optimization of the telluric correction failed and the default atran model was used for the reduction. So the GO might want to examine the G063 data to see if there are issues with the telluric correction in the data.</p>
</section>
<section id="Slit-Orientation-on-the-Sky">
<h2>Slit Orientation on the Sky<a class="headerlink" href="#Slit-Orientation-on-the-Sky" title="Permalink to this headline"></a></h2>
<p>For some observations, it is important to know the slit orientation and geometry on the sky. The slit width (arcsec), height (arcsec), and long-axis position angle (degrees, E of N) are logged in the keywords SLTW_ARC, SLTH_ARC, and SKY_ANGL, respectively:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Display keywords related to slit geometry:</span>
<span class="n">slit_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SLTW_ARC&quot;</span><span class="p">,</span> <span class="s2">&quot;SLTH_ARC&quot;</span><span class="p">,</span> <span class="s2">&quot;SKY_ANGL&quot;</span><span class="p">]</span>

<span class="c1"># Loop over keywords to print.</span>
<span class="k">for</span> <span class="n">kywd</span> <span class="ow">in</span> <span class="n">slit_keywords</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">kywd</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="n">g063_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">kywd</span><span class="p">],</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">g063_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="n">kywd</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
SLTW_ARC = 4.7 / Slit width in arcseconds
SLTH_ARC = 194.3 / Slit height in arcseconds
SKY_ANGL = 261.527 / &#34;up&#34; on det from N, coords.pos.sibs.vpa
</pre></div></div>
</div>
<p>We can use the slit information and sky position to create a DS9 region file which can then be imported into DS9 and overplotted on any image of the object with a valid WCS. Specification for regions in DS9 can be found here: <a class="reference external" href="http://ds9.si.edu/doc/ref/region.html">http://ds9.si.edu/doc/ref/region.html</a>. Note that either the TELRA/DEC or OBSRA/DEC can be used for the sky position: TELRA/DEC is the sky position as reported by the telescope at the time of the observation whereas OBSRA/DEC is the sky position specified by the observer in
the AOR. Due to various issues, the TELRA/DEC is not always accurate, especially for chop/nod observations. We recommend trying both and contacting your instrument scientist if there is a discrepancy.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># First store the relevant values in local variables, for convenience.</span>
<span class="nb">object</span> <span class="o">=</span> <span class="n">g063_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;OBJECT&quot;</span><span class="p">]</span>
<span class="n">ra</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mf">15.0</span> <span class="o">*</span> <span class="n">g063_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;OBSRA&quot;</span><span class="p">])</span>  <span class="c1"># converting from hours to degrees</span>
<span class="n">dec</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">g063_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;OBSDEC&quot;</span><span class="p">])</span>
<span class="n">slitw_arc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">g063_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;SLTW_ARC&quot;</span><span class="p">])</span>
<span class="n">slith_arc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">g063_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;SLTH_ARC&quot;</span><span class="p">])</span>
<span class="n">sky_angl</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">g063_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;SKY_ANGL&quot;</span><span class="p">])</span>

<span class="c1"># now create a regions file and write the values above in according to region file spec:</span>
<span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="nb">object</span> <span class="o">+</span> <span class="s2">&quot;_slit.reg&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
<span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Region file format: DS9 version 4.1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
    <span class="s1">&#39;global color=green dashlist=8 3 width=1 font=&quot;helvetica 10 normal roman&quot; select=1 highlite=1 dash=0 fixed=0 edit=1 move=1 delete=1 include=1 source=1</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;fk5</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
    <span class="s2">&quot;box(&quot;</span>
    <span class="o">+</span> <span class="n">ra</span>
    <span class="o">+</span> <span class="s2">&quot;d,&quot;</span>
    <span class="o">+</span> <span class="n">dec</span>
    <span class="o">+</span> <span class="s2">&quot;d,&quot;</span>
    <span class="o">+</span> <span class="n">slitw_arc</span>
    <span class="o">+</span> <span class="s1">&#39;&quot;,&#39;</span>
    <span class="o">+</span> <span class="n">slith_arc</span>
    <span class="o">+</span> <span class="s1">&#39;&quot;,&#39;</span>
    <span class="o">+</span> <span class="n">sky_angl</span>
    <span class="o">+</span> <span class="s2">&quot;) # text = {&quot;</span>
    <span class="o">+</span> <span class="nb">object</span>
    <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
<span class="p">)</span>
<span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>To use the region file, first load an image of your target into DS9. In this example, we will load a WISE image of AB Aur:</p>
<img alt="WISE Band 1 Image of AB Aur" src="_images/ds9_abaur.png" />
<p>Then click “Regions” -&gt; “Load Region…”, navigate to the local directory where your region file was saved, and click on the region file (in this example: “AB Aur (1) slit.reg”). Format should be “ds9”; the slit size and orientation should then be overplotted on the image:</p>
<img alt="WISE Band 1 Image of AB Aur, with slit overlay" src="_images/ds9_abaur-slit.png" />
</section>
<section id="Reading-the-File-and-Loading-the-Data-into-a-Table-Structure">
<h2>Reading the File and Loading the Data into a Table Structure<a class="headerlink" href="#Reading-the-File-and-Loading-the-Data-into-a-Table-Structure" title="Permalink to this headline"></a></h2>
<p>Now we’ll read a FITS file for the grism of interest and load the data into a convenient set of table structures in Python. We’ll start with the G227 (22.7 <span class="math notranslate nohighlight">\(\mu\)</span>m) grism data. The file contains a single HDU containing a 5 x 236 array. Now place the data portion into a separate table structure for convenience:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Define a function for loading fits data into tables with units</span>
<span class="k">def</span> <span class="nf">loadFORCASTGrismData</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1"># Now open fits file for the sample data...</span>
    <span class="n">data_fits</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># ... read the data portion of the file into a separate array:</span>
    <span class="n">data_tmp</span> <span class="o">=</span> <span class="n">data_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># ... load into table for convenience:</span>
    <span class="n">data_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="p">[</span><span class="n">data_tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data_tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data_tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">data_tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]],</span>
        <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;wavelength&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;telluric&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">),</span>
        <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Data Table&quot;</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># ...and assign units:</span>
    <span class="n">data_table</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;micron&quot;</span>
    <span class="n">data_table</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;Jy&quot;</span>
    <span class="n">data_table</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;Jy&quot;</span>
    <span class="n">data_table</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;1/(Jy*s)&quot;</span>  <span class="c1"># response is (Me-/s)/Jy</span>

    <span class="c1"># ...and mask NaNs in the flux.</span>
    <span class="n">data_table</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_table</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">data_fits</span><span class="p">,</span> <span class="n">data_table</span>  <span class="c1"># return both the FITS structure and the table.</span>


<span class="c1"># Now read the file for the G227 data:</span>
<span class="n">g227_fits</span><span class="p">,</span> <span class="n">g227</span> <span class="o">=</span> <span class="n">loadFORCASTGrismData</span><span class="p">(</span>
    <span class="s2">&quot;../example_data/FORCAST/F0434_FO_GRI_0501383_FORG227_CMB_0230-0233.fits&quot;</span>
<span class="p">)</span>

<span class="n">g227</span><span class="o">.</span><span class="n">info</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Table masked=True length=236&gt;
   name     dtype     unit    n_bad
---------- ------- ---------- -----
wavelength float64     micron     0
      flux float64         Jy     4
     error float64         Jy     0
  telluric float64                0
  response float64 1 / (Jy s)     0
</pre></div></div>
</div>
</section>
<section id="Plotting-the-Spectra">
<h2>Plotting the Spectra<a class="headerlink" href="#Plotting-the-Spectra" title="Permalink to this headline"></a></h2>
<p>Start by plotting flux (with errors) and S/N as a function of wavelength:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
    <span class="n">g227</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g227</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">g227</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Flux&quot;</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;G227&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;F$_v$ (Jy)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/srgoldma/opt/anaconda3/lib/python3.9/site-packages/numpy/core/_asarray.py:171: UserWarning: Warning: converting a masked element to nan.
  return array(a, dtype, copy=False, order=order, subok=True)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7fd9a57b55b0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_Inspection-1_24_2.png" src="_images/FORCAST-Grism_Inspection-1_24_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">g227</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g227</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">g227</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;SNR&quot;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;mid&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;G227&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;SNR&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7fd9a5e2d4f0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_Inspection-1_25_1.png" src="_images/FORCAST-Grism_Inspection-1_25_1.png" />
</div>
</div>
<p>In order to assess whether any particular features in the spectrum are real or not, it is important to compare the flux to the telluric transmission. We’ll write a short function for comparing flux spectrum to telluric transmission from the same data table.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Define a function to plot two spectra from the same FORCAST data table:</span>
<span class="k">def</span> <span class="nf">compareTelluric</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;F$_v$ (Jy)&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
        <span class="n">table</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Flux&quot;</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">)</span>

    <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;tab:red&quot;</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># instantiate a second axes that shares the same x-axis</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Transmission&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">table</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span>
        <span class="n">table</span><span class="p">[</span><span class="s2">&quot;telluric&quot;</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Telluric Transmission&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="c1"># plt.title(table)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>


<span class="n">compareTelluric</span><span class="p">(</span><span class="n">g227</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/srgoldma/opt/anaconda3/lib/python3.9/site-packages/numpy/core/_asarray.py:171: UserWarning: Warning: converting a masked element to nan.
  return array(a, dtype, copy=False, order=order, subok=True)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_Inspection-1_27_1.png" src="_images/FORCAST-Grism_Inspection-1_27_1.png" />
</div>
</div>
<p>It is clear form this plot that most of the “features” in the spectrum are in fact residuals left over from the telluric correction. It is sometimes possible to improve the correction by careful modelling of the atmospheric lines, but some residuals are almost always present.</p>
<p>For very low-S/N data, it is useful to look at both the telluric transmission and the response. Here we’ll take a look at the G329 grism data as an example:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Read in data for G329 grism using the function we defined earlier:</span>
<span class="n">g329_fits</span><span class="p">,</span> <span class="n">g329</span> <span class="o">=</span> <span class="n">loadFORCASTGrismData</span><span class="p">(</span>
    <span class="s2">&quot;../example_data/FORCAST/F0434_FO_GRI_0501384_FORG329_CMB_0239-0246.fits&quot;</span>
<span class="p">)</span>


<span class="c1"># now plot flux and telluric transmission together</span>
<span class="n">compareTelluric</span><span class="p">(</span><span class="n">g329</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/srgoldma/opt/anaconda3/lib/python3.9/site-packages/numpy/core/_asarray.py:171: UserWarning: Warning: converting a masked element to nan.
  return array(a, dtype, copy=False, order=order, subok=True)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_Inspection-1_29_1.png" src="_images/FORCAST-Grism_Inspection-1_29_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># and now plot flux and response  together</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;F$_v$ (Jy)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
    <span class="n">g329</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g329</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">g329</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Flux&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">)</span>

<span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;tab:red&quot;</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># instantiate a second axes that shares the same x-axis</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Response&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">g329</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g329</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Response&quot;</span>
<span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;G329&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/srgoldma/opt/anaconda3/lib/python3.9/site-packages/numpy/core/_asarray.py:171: UserWarning: Warning: converting a masked element to nan.
  return array(a, dtype, copy=False, order=order, subok=True)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;G329&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_Inspection-1_30_2.png" src="_images/FORCAST-Grism_Inspection-1_30_2.png" />
</div>
</div>
<p>Due to the strong telluric absorption coupled with relatively low response, the flux values for <span class="math notranslate nohighlight">\(\lambda\)</span> &gt; 35 <span class="math notranslate nohighlight">\(\mu\)</span>m should be viewed with some caution.</p>
</section>
<section id="Masking-Regions-with-Strong-Telluric-Features">
<h2>Masking Regions with Strong Telluric Features<a class="headerlink" href="#Masking-Regions-with-Strong-Telluric-Features" title="Permalink to this headline"></a></h2>
<p>Regions with particularly strong telluric absorption generally suffer from very poor correction and should be masked out. For example, the G111 grism generally suffers from poor correction at 9.6 <span class="math notranslate nohighlight">\(\mu\)</span>m due to the very deep telluric O3 band there:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Read in data for G111 grism using the function we defined earlier:</span>
<span class="n">g111_fits</span><span class="p">,</span> <span class="n">g111</span> <span class="o">=</span> <span class="n">loadFORCASTGrismData</span><span class="p">(</span>
    <span class="s2">&quot;../example_data/FORCAST/F0434_FO_GRI_0501382_FORG111_CMB_0234-0238.fits&quot;</span>
<span class="p">)</span>

<span class="c1"># and use our plotting function from earlier to compare flux to telluric transmission:</span>
<span class="n">compareTelluric</span><span class="p">(</span><span class="n">g111</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/srgoldma/opt/anaconda3/lib/python3.9/site-packages/numpy/core/_asarray.py:171: UserWarning: Warning: converting a masked element to nan.
  return array(a, dtype, copy=False, order=order, subok=True)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_Inspection-1_33_1.png" src="_images/FORCAST-Grism_Inspection-1_33_1.png" />
</div>
</div>
<p>Now mask out all flux values for which the transmission is less than some threshold (0.7 in this example) and re-plot. Note that matplot lib automatically applies the mask to the data when plotting.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Pick masking threshold for telluric transmission:</span>
<span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.7</span>

<span class="c1"># and generate masks for flux and error columns.</span>
<span class="n">g111</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">g111</span><span class="p">[</span><span class="s2">&quot;telluric&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">thresh</span>
<span class="n">g111</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">g111</span><span class="p">[</span><span class="s2">&quot;telluric&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">thresh</span>

<span class="c1"># Re-plot; masks are applied automatically.</span>
<span class="n">compareTelluric</span><span class="p">(</span><span class="n">g111</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/srgoldma/opt/anaconda3/lib/python3.9/site-packages/numpy/core/_asarray.py:171: UserWarning: Warning: converting a masked element to nan.
  return array(a, dtype, copy=False, order=order, subok=True)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_Inspection-1_35_1.png" src="_images/FORCAST-Grism_Inspection-1_35_1.png" />
</div>
</div>
</section>
<section id="Plotting-the-Complete-SED">
<h2>Plotting the Complete SED<a class="headerlink" href="#Plotting-the-Complete-SED" title="Permalink to this headline"></a></h2>
<p>Now we can load the last grism data file (G063) and plot the full SED from 5 – 40 mic.:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># And finally, read in the G063 data:</span>

<span class="n">g063_fits</span><span class="p">,</span> <span class="n">g063</span> <span class="o">=</span> <span class="n">loadFORCASTGrismData</span><span class="p">(</span>
    <span class="s2">&quot;../example_data/FORCAST/F0434_FO_GRI_0501381_FORG063_CMB_0228-0229.fits&quot;</span>
<span class="p">)</span>

<span class="c1"># Now plot all grism data together as a line plot, semi-log</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">g063</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g063</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G063&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">g111</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g111</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G111&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">g227</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g227</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G227&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">g329</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g329</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G329&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;AB Aur&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;F$_v$ (Jy)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7fd9a5680eb0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_Inspection-1_37_1.png" src="_images/FORCAST-Grism_Inspection-1_37_1.png" />
</div>
</div>
<p>(Notice that Python automatically uses the masked data for G111.)</p>
<p>The first thing we notice is that there appears to be a flux break or discrepancy between the G227 and G329 grisms, which is most likely due to additional slit losses for the G329 data.</p>
</section>
<section id="Calibration-Using-Independant-Photometry">
<h2>Calibration Using Independant Photometry<a class="headerlink" href="#Calibration-Using-Independant-Photometry" title="Permalink to this headline"></a></h2>
<p>The absolute flux calibration accuracy of the grism data can be uncertain by &gt;10% due to systematic uncertainties at the time of observation (e.g. poor atmospheric conditions, bad seeing, or slit mis-alignment). In this section, we show how to use independant FORCAST photometric observations to “re-calibrate” the grism data (assuming the imaging observations are considered accurate).</p>
<p>The most common reason for systematic error in the grism flux data is mis-alignment of the slit during the observation. Since the width of the FORCAST slits are smaller than the SOFIA PSF in general, the slit only “samples” a fraction of the flux from the source. The FORCAST pipeline accounts for this “loss” automatically for each grism using a default PSF model. However, if the target is not centered on the slit during the observation, or if the image quality is poor, there can be an additional
loss that is <em>not</em> accounted for in the pipeline processing. These additional “slit losses” can be assessed and “fixed” using trusted absolute photometry from the same spectral region. For the sample data, we also have photometric fluxes for each grism band pass which we use to compare to the grism spectra below.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Create a table of values for the photometry</span>
<span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;F064&quot;</span><span class="p">,</span> <span class="s2">&quot;F111&quot;</span><span class="p">,</span> <span class="s2">&quot;F197&quot;</span><span class="p">,</span> <span class="s2">&quot;F315&quot;</span><span class="p">]</span>
<span class="n">waves</span> <span class="o">=</span> <span class="p">[</span><span class="mf">6.34774</span><span class="p">,</span> <span class="mf">11.0888</span><span class="p">,</span> <span class="mf">19.6993</span><span class="p">,</span> <span class="mf">31.3615</span><span class="p">]</span>  <span class="c1"># microns</span>
<span class="n">delwaves</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="mf">5.7</span><span class="p">]</span>  <span class="c1"># filter bandpass (FWHM, microns)</span>
<span class="n">fluxes</span> <span class="o">=</span> <span class="p">[</span><span class="mf">12.854</span><span class="p">,</span> <span class="mf">26.778</span><span class="p">,</span> <span class="mf">47.129</span><span class="p">,</span> <span class="mf">77.264</span><span class="p">]</span>  <span class="c1"># Jy</span>
<span class="n">relerrs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.063705</span><span class="p">,</span> <span class="mf">0.073197</span><span class="p">,</span> <span class="mf">0.063439</span><span class="p">,</span> <span class="mf">0.089142</span><span class="p">]</span>  <span class="c1"># absolute uncertainty (ratio)</span>


<span class="n">phot</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="p">[</span><span class="n">filters</span><span class="p">,</span> <span class="n">waves</span><span class="p">,</span> <span class="n">fluxes</span><span class="p">,</span> <span class="n">relerrs</span><span class="p">,</span> <span class="n">delwaves</span><span class="p">],</span>
    <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;filter&quot;</span><span class="p">,</span> <span class="s2">&quot;wave&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;relerr&quot;</span><span class="p">,</span> <span class="s2">&quot;delwave&quot;</span><span class="p">),</span>
    <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Photometry Data Table&quot;</span><span class="p">},</span>
<span class="p">)</span>

<span class="n">phot</span><span class="p">[</span><span class="s2">&quot;wave&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;micron&quot;</span>
<span class="n">phot</span><span class="p">[</span><span class="s2">&quot;delwave&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;micron&quot;</span>
<span class="n">phot</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;Jy&quot;</span>

<span class="c1"># Now plot all grism data together as a line plot, using semi-log (x-axis)</span>
<span class="n">fp</span> <span class="o">=</span> <span class="s2">&quot;tab:blue&quot;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">g063</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g063</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G063&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">g111</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g111</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G111&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">g227</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g227</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G227&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">g329</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g329</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G329&quot;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
    <span class="n">phot</span><span class="p">[</span><span class="s2">&quot;wave&quot;</span><span class="p">],</span>
    <span class="n">phot</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span>
    <span class="n">xerr</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">phot</span><span class="p">[</span><span class="s2">&quot;delwave&quot;</span><span class="p">],</span>
    <span class="n">yerr</span><span class="o">=</span><span class="n">phot</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">phot</span><span class="p">[</span><span class="s2">&quot;relerr&quot;</span><span class="p">],</span>
    <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Photometry&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;AB Aur&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;F$_v$ (Jy)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7fd9a5e8faf0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_Inspection-1_40_1.png" src="_images/FORCAST-Grism_Inspection-1_40_1.png" />
</div>
</div>
<p>The grism spectra match up very well with the photometry <em>except</em> for G329 which appears too low, most likely due to slit misalignment during the observation. Assuming the losses are independant of wavelength, the grism data can be shifted up to match the photometric value by simply averaging the grism data (weighted by the filter transmission), calculating the offset between the average grism flux and the photometric flux, and applying that offset to the grism flux data. Filter transmission
curves can be found in the FORCAST Observers Handbook, which is available from the <a class="reference external" href="https://www.sofia.usra.edu/node/1454">SOFIA Proposal Resources</a> page.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># read in filter transmission file from SOFIA website.</span>
<span class="n">f315</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
    <span class="s2">&quot;https://www.sofia.usra.edu/sites/default/files/31pt5mu.txt&quot;</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;wave&quot;</span><span class="p">,</span> <span class="s2">&quot;trans&quot;</span><span class="p">),</span>
<span class="p">)</span>


<span class="c1"># re-bin transmission onto our grism data wavelength grid and save in new array.</span>
<span class="n">f315_wts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">g329</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">f315</span><span class="p">[</span><span class="s2">&quot;wave&quot;</span><span class="p">],</span> <span class="n">f315</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">])</span>

<span class="c1"># and now plot flux and response  together</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;F$_v$ (Jy)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
    <span class="n">g329</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g329</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">g329</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Flux&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">)</span>

<span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;tab:red&quot;</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># instantiate a second axes that shares the same x-axis</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;F315 Filter Transmission&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">g329</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span>
    <span class="n">f315_wts</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Filter Transmission&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/srgoldma/opt/anaconda3/lib/python3.9/site-packages/numpy/core/_asarray.py:171: UserWarning: Warning: converting a masked element to nan.
  return array(a, dtype, copy=False, order=order, subok=True)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7fd988c7b610&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_Inspection-1_42_2.png" src="_images/FORCAST-Grism_Inspection-1_42_2.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># now compute weighted average using the filter transmission for the weights.</span>
<span class="n">g329_av</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">g329</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">f315_wts</span><span class="p">)</span>

<span class="c1"># and shift the spectrum up by the difference</span>
<span class="n">g329_f_adj</span> <span class="o">=</span> <span class="n">g329</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">g329_av</span><span class="p">)</span>

<span class="c1"># and add to the data table</span>
<span class="n">g329</span><span class="p">[</span><span class="s2">&quot;flux_adj&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g329_f_adj</span>
<span class="n">g329</span><span class="p">[</span><span class="s2">&quot;flux_adj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;Jy&quot;</span>
</pre></div>
</div>
</div>
<p>Here we’ve added an extra column for the new “adjusted” flux spectrum. Now re-plot with the adjusted values for G329:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fp</span> <span class="o">=</span> <span class="s2">&quot;tab:blue&quot;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># plot all grism settings</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">g063</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g063</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G063&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">g111</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g111</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G111&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">g227</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g227</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G227&quot;</span><span class="p">)</span>

<span class="c1"># plot adjusted spectrum for g329</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span>
    <span class="n">g329</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g329</span><span class="p">[</span><span class="s2">&quot;flux_adj&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G329 Adj&quot;</span>
<span class="p">)</span>  <span class="c1"># &lt;--- Adjusted spectrum</span>

<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
    <span class="n">phot</span><span class="p">[</span><span class="s2">&quot;wave&quot;</span><span class="p">],</span>
    <span class="n">phot</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">],</span>
    <span class="n">xerr</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">phot</span><span class="p">[</span><span class="s2">&quot;delwave&quot;</span><span class="p">],</span>
    <span class="n">yerr</span><span class="o">=</span><span class="n">phot</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">phot</span><span class="p">[</span><span class="s2">&quot;relerr&quot;</span><span class="p">],</span>
    <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;FORCAST Phot (2017)&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;AB Aur&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;F$_v$ (Jy)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7fd9a6178f10&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_Inspection-1_45_1.png" src="_images/FORCAST-Grism_Inspection-1_45_1.png" />
</div>
</div>
<p>The adjusted G329 spectrum now matches the G227 spectrum very nicely.</p>
<p>USER EXERCISE: Use the F197 photometry and filter curve to re-calibrate the G227 grism spectrum. In this case, the overall grism flux should come <em>down</em> just a little.</p>
</section>
<section id="Converting-to-\lambdaF_{\lambda}">
<h2>Converting to <span class="math notranslate nohighlight">\(\lambda\)</span>F<span class="math notranslate nohighlight">\(_{\lambda}\)</span><a class="headerlink" href="#Converting-to-\lambdaF_{\lambda}" title="Permalink to this headline"></a></h2>
<p>We often want to work with <span class="math notranslate nohighlight">\(\lambda\)</span>F<span class="math notranslate nohighlight">\(_{\lambda}\)</span> in order to assess where the object is emitting the most power (per logade or decade). AstroPy quantities and constants makes this easy. Remember that <span class="math notranslate nohighlight">\(\lambda\)</span>F<span class="math notranslate nohighlight">\(_{\lambda}\)</span> = <span class="math notranslate nohighlight">\(v\)</span>F<span class="math notranslate nohighlight">\(_v\)</span> = c * F<span class="math notranslate nohighlight">\(_v\)</span> / <span class="math notranslate nohighlight">\(\lambda\)</span>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Calculate lam f_lam (= nu F_nu = c * F_nu / lambda), convert to W/m^2, and add to table with mask if it exists.</span>

<span class="n">lamflam</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="n">g063</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">g063</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">]</span>  <span class="c1"># calculate</span>
<span class="n">lamflam</span> <span class="o">=</span> <span class="n">lamflam</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">W</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">))</span>  <span class="c1"># and convert to W/m^2</span>
<span class="n">g063</span><span class="p">[</span><span class="s2">&quot;lamflam&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lamflam</span>  <span class="c1"># ...put in table...</span>

<span class="n">lamflam</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="n">g111</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">g111</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">]</span>  <span class="c1"># calculate</span>
<span class="n">lamflam</span> <span class="o">=</span> <span class="n">lamflam</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">W</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">))</span>  <span class="c1"># and convert to W/m^2</span>
<span class="n">g111</span><span class="p">[</span><span class="s2">&quot;lamflam&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lamflam</span>  <span class="c1"># ...put in table...</span>
<span class="n">g111</span><span class="p">[</span><span class="s2">&quot;lamflam&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">g111</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span>  <span class="c1"># ...and dont forget to mask lamflam as well.</span>

<span class="n">lamflam</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="n">g227</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">g227</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">]</span>  <span class="c1"># calculate</span>
<span class="n">lamflam</span> <span class="o">=</span> <span class="n">lamflam</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">W</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">))</span>  <span class="c1"># and convert to W/m^2</span>
<span class="n">g227</span><span class="p">[</span><span class="s2">&quot;lamflam&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lamflam</span>  <span class="c1"># ...put in table...</span>

<span class="n">lamflam</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">const</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="n">g329</span><span class="p">[</span><span class="s2">&quot;flux_adj&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">g329</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">]</span>
<span class="p">)</span>  <span class="c1"># calculate using adjusted flux</span>
<span class="n">lamflam</span> <span class="o">=</span> <span class="n">lamflam</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">W</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">))</span>  <span class="c1"># and convert to W/m^2</span>
<span class="n">g329</span><span class="p">[</span><span class="s2">&quot;lamflam&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lamflam</span>  <span class="c1"># ...put in table...</span>

<span class="n">g111</span><span class="o">.</span><span class="n">info</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Table masked=True length=242&gt;
   name     dtype     unit    n_bad
---------- ------- ---------- -----
wavelength float64     micron     0
      flux float64         Jy    24
     error float64         Jy    24
  telluric float64                0
  response float64 1 / (Jy s)     0
   lamflam float64     W / m2    24
</pre></div></div>
</div>
<p>We’ve retained MKS units, but it is easy to convert to CGS from here if desired.</p>
<p>And now re-plot with <span class="math notranslate nohighlight">\(\lambda\)</span>F<span class="math notranslate nohighlight">\(_{\lambda}\)</span>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fp</span> <span class="o">=</span> <span class="s2">&quot;tab:blue&quot;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># plot all grism settings</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">g063</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g063</span><span class="p">[</span><span class="s2">&quot;lamflam&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G063&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">g111</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g111</span><span class="p">[</span><span class="s2">&quot;lamflam&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G111&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">g227</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g227</span><span class="p">[</span><span class="s2">&quot;lamflam&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G227&quot;</span><span class="p">)</span>

<span class="c1"># plot adjusted spectrum for g329</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span>
    <span class="n">g329</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">],</span> <span class="n">g329</span><span class="p">[</span><span class="s2">&quot;lamflam&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G329 Adj&quot;</span>
<span class="p">)</span>  <span class="c1"># &lt;--- Adjusted spectrum</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;AB Aur&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$\lambda$F$_{\lambda}$ (W/m\^2)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7fd9a75137c0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_Inspection-1_50_1.png" src="_images/FORCAST-Grism_Inspection-1_50_1.png" />
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="FORCAST-photometry_detailed.html" class="btn btn-neutral float-left" title="FORCAST photometry (detailed)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="FORCAST-Grism_LineAnalysis-2.html" class="btn btn-neutral float-right" title="FORCAST Grism Spectra: Basic Line Analysis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, SOFIA/USRA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>