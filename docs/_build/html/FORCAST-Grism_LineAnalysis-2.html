<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FORCAST Grism Spectra: Basic Line Analysis &mdash; SOFIA tutorials  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="FORCAST Grism Spectra: Custom Spectral Extraction" href="FORCAST-Grism_CustomExtraction-3.html" />
    <link rel="prev" title="FORCAST Grism Spectra: Basic Inspection and Assessment" href="FORCAST-Grism_Inspection-1.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> SOFIA tutorials
            <img src="_static/sofia_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="SOFIA_data_retrieval.html">SOFIA data retrieval</a></li>
<li class="toctree-l1"><a class="reference internal" href="FORCAST-Basic_Photometry.html">FORCAST Basic photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="FORCAST-photometry_detailed.html">FORCAST photometry (detailed)</a></li>
<li class="toctree-l1"><a class="reference internal" href="FORCAST-Grism_Inspection-1.html">FORCAST Grism Spectra: Basic Inspection and Assessment</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">FORCAST Grism Spectra: Basic Line Analysis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Goals">Goals</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Imports">Imports</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Ingredients">Ingredients</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Cleaning-the-Data">Cleaning the Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Fitting-the-Continuum-Across-the-Grism">Fitting the Continuum Across the Grism</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Measuring-Line-Flux">Measuring Line Flux</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Line-Fitting">Line Fitting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="FORCAST-Grism_CustomExtraction-3.html">FORCAST Grism Spectra: Custom Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="HAWC_30_Dor.html">HAWC+ Data Recipe / 30 Doradus Data Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="EXES-Data-Inspection.html">EXES: Data inspection</a></li>
<li class="toctree-l1"><a class="reference internal" href="FIFI-LS_sospex.html">FIFI-LS: Basic Cube Analysis using SOSPEX</a></li>
<li class="toctree-l1"><a class="reference internal" href="GREAT-Class_primer.html">GREAT: Class primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="GREAT-Class_primer.html#Introduction">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="GREAT-Class_primer.html#Ingredients">Ingredients</a></li>
<li class="toctree-l1"><a class="reference internal" href="GREAT-Class_primer.html#Procedure">Procedure</a></li>
<li class="toctree-l1"><a class="reference internal" href="GREAT-Class_primer.html#Cleaning-up">Cleaning up</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SOFIA tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>FORCAST Grism Spectra: Basic Line Analysis</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/FORCAST-Grism_LineAnalysis-2.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="FORCAST-Grism-Spectra:-Basic-Line-Analysis">
<h1>FORCAST Grism Spectra: Basic Line Analysis<a class="headerlink" href="#FORCAST-Grism-Spectra:-Basic-Line-Analysis" title="Permalink to this headline"></a></h1>
<ul class="simple">
<li><p><strong>Aim</strong>: Basic line fluxes and line fitting of grism data.</p></li>
<li><p><strong>Data</strong>: Level 3 grism data of the Saturn Nebula (G111)</p></li>
<li><p><strong>Tools</strong>: astropy, specutils</p></li>
<li><p><strong>Instrument</strong>: FORCAST</p></li>
<li><p><strong>Documentation</strong>: <a class="reference external" href="https://www.sofia.usra.edu/sites/default/files/USpot_DCS_DPS/Documents/FORCAST_data_handbook.pdf">FORCAST data handbook</a></p></li>
<li><p><strong>Notebook repository</strong>: <a class="reference external" href="https://github.com/SOFIAObservatory/Recipes">https://github.com/SOFIAObservatory/Recipes</a></p></li>
</ul>
<section id="Goals">
<h2>Goals<a class="headerlink" href="#Goals" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>Load and clean grism data</p></li>
<li><p>Fit the continuum</p></li>
<li><p>Measure the line fluxes</p></li>
<li><p>Fit a spectral lines with a 1D Guassian</p></li>
</ul>
</section>
<section id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this headline"></a></h2>
<p>This recipe provides an overview and sample code (in Python) for some simple line analysis tasks using FORCAST grism observations. We recommend that the user reviews the first FORCAST Grism Recipe (<a class="reference internal" href="FORCAST-Grism_Inspection-1.html"><span class="doc">FORCAST Grism Recipe: Basic Inspection and Assessment</span></a>) before proceeding with this slightly more advanced tutorial.</p>
<p>Raw FORCAST data suffers from several instrumental artifacts. Nearly all of the artifacts are removed or corrected by the FORCAST pipeline, including: bad pixels; the Droop effect; non-linear pixel response; and the “jailbar” effect. In addition, the grism pipeline extracts the one-dimensional spectra, applies both wavelength and flux calibration, and corrects for telluric absorption. For point sources, an “optimal extraction” algorithm is used, while for extended (non-pointlike) sources, a
standard summation over a manually defined aperture is used. See the <a class="reference external" href="https://www.sofia.usra.edu/sites/default/files/USpot_DCS_DPS/Documents/FORCAST_data_handbook.pdf">FORCAST GO Data Handbook</a> for details regarding the artifacts, pipeline algorithms, and the flux-calibration process.</p>
<p>In this recipe we show the user how to do some minor “cleaning” of the LEVEL_3 data and then some basic emission line analysis including continuum fitting and subtraction, line flux measurement, and simple line fitting.</p>
<p>There are a handful of relatively mature spectral line analysis in python, including linetools and pyspeckit. For this recipe/example, we are using specutils since this seems to be the most general package.</p>
</section>
<section id="Imports">
<h2>Imports<a class="headerlink" href="#Imports" title="Permalink to this headline"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span><span class="n">QTable</span><span class="p">,</span><span class="n">Column</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">quantity_support</span>

<span class="kn">from</span> <span class="nn">specutils</span> <span class="kn">import</span> <span class="n">Spectrum1D</span><span class="p">,</span> <span class="n">SpectralRegion</span>
<span class="kn">from</span> <span class="nn">specutils.fitting</span> <span class="kn">import</span> <span class="n">fit_generic_continuum</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">quantity_support</span><span class="p">()</span> <span class="p">;</span>
</pre></div>
</div>
</div>
</section>
<section id="Ingredients">
<h2>Ingredients<a class="headerlink" href="#Ingredients" title="Permalink to this headline"></a></h2>
<ol class="arabic simple">
<li><p>Level 3 (flux calibrated) FORCAST grism data (either CAL or CMB files) from the Infrared Science Archive (<a class="reference external" href="https://irsa.ipac.caltech.edu/Missions/sofia.html">IRSA</a>).</p></li>
<li><p>Sample Data (if desired): In this example we will be using observations of the PN NGC 7009.</p>
<ul class="simple">
<li><p>Level 3 data can be obtained from the IRSA using the following search criteria:</p>
<ul>
<li><p>Coordinates or Object Name = NGC 7009</p></li>
<li><p>Radius = 100 arcseconds</p></li>
<li><p>Mission ID = “2017-08-07_FO_F428”</p></li>
<li><p>AOR ID = 05_0063_7</p></li>
<li><p>Instrument = FORCAST</p></li>
<li><p>Processing State = Level 3</p></li>
</ul>
</li>
<li><p>Download all data and save to local desktop.</p></li>
<li><p><strong>You can download the example data directly</strong><a class="reference external" href="https://zenodo.org/record/5706312/files/FORCAST-Grism_Inspection-example-data.zip?download=1">here</a>.</p></li>
<li><p>For this example we will be using the following files:</p>
<ul>
<li><p>F0428_FO_GRI_0500637_FORG111_CAL_0177-0196.fits</p></li>
<li><p>F0428_FO_GRI_0500638_FORG227_CMB_0197-0215.fits</p></li>
</ul>
</li>
<li><p>For convenience, we recommend saving both files in a folder called “forcast-sample-data” in the same directory as this Python Notebook.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://www.sofia.usra.edu/sites/default/files/USpot_DCS_DPS/Documents/FORCAST_data_handbook.pdf">FORCAST GO Data Handbook</a> for reference (latest version can be found on the <a class="reference external" href="https://www.sofia.usra.edu/science/proposing-and-observing/data-products/data-resources">SOFIA Data Products and Archives page</a>)</p></li>
<li><p>Download and install specutils from the <a class="reference external" href="http://www.astropy.org/affiliated/index.html">AstroPy Affiliated Packages</a> page.</p></li>
</ol>
</section>
<section id="Cleaning-the-Data">
<h2>Cleaning the Data<a class="headerlink" href="#Cleaning-the-Data" title="Permalink to this headline"></a></h2>
<p>First we’ll load the calibrated data for a single grism observation (G111 in this example) and take a look at the spectrum.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Define a function for loading fits data into table structure,</span>
<span class="c1">#keeping the FITS data for later use if needed.</span>
<span class="k">def</span> <span class="nf">loadFORCASTGrismData</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1">#Now open fits file for the sample data...</span>
    <span class="n">data_fits</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1">#... read the data portion of the file into a separate array:</span>
    <span class="n">data_tmp</span> <span class="o">=</span> <span class="n">data_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="c1">#... load into table for convenience</span>
    <span class="n">data_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">data_tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data_tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">data_tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">data_tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">data_tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]],</span>
                  <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;telluric&#39;</span><span class="p">,</span> <span class="s1">&#39;response&#39;</span><span class="p">),</span> <span class="n">masked</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Data Table&#39;</span><span class="p">})</span>

    <span class="c1">#and assign units.</span>
    <span class="n">data_table</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;micron&#39;</span>
    <span class="n">data_table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;Jy&#39;</span>
    <span class="n">data_table</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;Jy&#39;</span>
    <span class="n">data_table</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;Jy/s&#39;</span>

    <span class="c1">#...and mask out NaNs in flux.</span>
    <span class="n">data_table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">data_fits</span><span class="p">,</span><span class="n">data_table</span>


<span class="c1">#Calibrated data file on local disk:</span>
<span class="n">calfile</span> <span class="o">=</span> <span class="s1">&#39;../example_data/FORCAST/F0428_FO_GRI_0500637_FORG111_CAL_0177-0196.fits&#39;</span>

<span class="c1">#Load fits data and tabular data...</span>
<span class="n">g111_fits</span><span class="p">,</span> <span class="n">g111_tab</span><span class="o">=</span><span class="n">loadFORCASTGrismData</span><span class="p">(</span><span class="n">calfile</span><span class="p">)</span>

<span class="c1">#And plot flux and telluric spectra</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;F$_v$ (Jy)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">],</span><span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span><span class="n">yerr</span><span class="o">=</span><span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">],</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Flux&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">)</span>

<span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:red&#39;</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># instantiate a second axes that shares the same x-axis</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Transmission&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">],</span><span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;telluric&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Telluric&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/srgoldma/opt/anaconda3/lib/python3.9/site-packages/numpy/core/_asarray.py:171: UserWarning: Warning: converting a masked element to nan.
  return array(a, dtype, copy=False, order=order, subok=True)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_LineAnalysis-2_7_1.png" src="_images/FORCAST-Grism_LineAnalysis-2_7_1.png" />
</div>
</div>
<p>This G111 spectrum appears to contain two strong emission lines: one at ~9.0<span class="math notranslate nohighlight">\(\mu\)</span>m (ArIII) and a very strong one at ~10.5<span class="math notranslate nohighlight">\(\mu\)</span>m (SIV). A nice table of line wavelengths and strengths can be found on the <a class="reference external" href="http://www.mpe.mpg.de/ir/ISO/linelists/">MPE website</a>. There are two main issues we need to “clean” before proceeding with line analysis: NaN values and noisy data due to deep telluric features. We’ll define a function for this that creates a mask and then uses it to create
a new “clean”-ed table of wavelength, flux, and error (leaving the telluric and response sprectra behind). We already masked the NaNs when we read the FITS file and created the data tables, so we just need to add the telluric regions to the mask.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Define a &quot;clean&quot;-ing function, that takes a FORCAST data table and telluric threshold as inputs:</span>

<span class="k">def</span> <span class="nf">cleanFORCASTGrismData</span><span class="p">(</span><span class="n">in_table</span><span class="p">,</span><span class="n">tell_thresh</span><span class="p">):</span>
    <span class="c1">#Now define mask (= True) for telluric transmission and add to the exisitng mask.</span>
    <span class="n">in_table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span>  <span class="o">=</span> <span class="n">in_table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">in_table</span><span class="p">[</span><span class="s1">&#39;telluric&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tell_thresh</span><span class="p">)</span>

    <span class="c1">#and apply NOT(Mask) to the wavelength, flux, and error arrays,</span>
    <span class="c1">#to pull out new &quot;clean&quot; arrays</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="n">in_table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">in_table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">wc</span> <span class="o">=</span> <span class="n">in_table</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">in_table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">fc_err</span> <span class="o">=</span> <span class="n">in_table</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">in_table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>

    <span class="c1">#and return a new table with cleaned arrays</span>
    <span class="c1">#Need to use QTable here to support specutils later.</span>
    <span class="k">return</span> <span class="n">QTable</span><span class="p">([</span><span class="n">wc</span><span class="p">,</span><span class="n">fc</span><span class="p">,</span><span class="n">fc_err</span><span class="p">],</span>
                  <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">),</span> <span class="n">masked</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Cleaned Spectrum&#39;</span><span class="p">})</span>


<span class="c1">#and now execute on our data for G111 with a telluric threshold of 0.75</span>
<span class="n">g111_clean</span> <span class="o">=</span> <span class="n">cleanFORCASTGrismData</span><span class="p">(</span><span class="n">g111_tab</span><span class="p">,</span><span class="mf">0.75</span><span class="p">)</span>

<span class="c1">#And plot flux and errors</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Flux&quot;</span><span class="p">)</span>
<span class="c1">#plt.legend(loc=&quot;lower left&quot;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;F$_v$ (Jy)&#39;</span><span class="p">);</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_LineAnalysis-2_9_0.png" src="_images/FORCAST-Grism_LineAnalysis-2_9_0.png" />
</div>
</div>
<p>Now that the spectrum is cleaned, we are ready to begin some simple line analysis.</p>
</section>
<section id="Fitting-the-Continuum-Across-the-Grism">
<h2>Fitting the Continuum Across the Grism<a class="headerlink" href="#Fitting-the-Continuum-Across-the-Grism" title="Permalink to this headline"></a></h2>
<p>Our first analysis task is to fit the continuum across the grism. In this step, the hard part is identifying all the sections of “line-free” continuum. There are many ways to do this automatically, but in this example we will simply estimate the continuum regions by eye. The easiest way to bookkeep this is to identify all the regions with lines first, then logically invert those regions to extract the continuum. In the G111 case above, we have two lines: one at ~9.0 <span class="math notranslate nohighlight">\(\mu\)</span>m and another
stronger one at ~10.5 <span class="math notranslate nohighlight">\(\mu\)</span>m. So lets define our line regions as: - 8.88 – 9.15 <span class="math notranslate nohighlight">\(\mu\)</span>m - 10.25 – 10.75 <span class="math notranslate nohighlight">\(\mu\)</span>m</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#As usual, lets define a function that takes a list of line regions and extracts everything external to</span>
<span class="c1">#those regions as continuum:</span>
<span class="k">def</span> <span class="nf">createContinuumSpectrum</span><span class="p">(</span><span class="n">in_table</span><span class="p">,</span><span class="n">line_regions</span><span class="p">):</span>
    <span class="n">wave</span> <span class="o">=</span> <span class="n">in_table</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">in_table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">in_table</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>

    <span class="c1">#initialize the continuum mask, where T corresponds to &quot;is Continuum&quot;.</span>
    <span class="n">cont_mask</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span> <span class="o">&lt;</span> <span class="n">wave</span>  <span class="c1">#initialize to FALSE</span>

    <span class="c1">#for each line region...</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line_regions</span><span class="p">:</span>
        <span class="c1">#...update mask value to TRUE for all points *outside* of that region</span>
        <span class="n">cont_mask</span> <span class="o">=</span> <span class="n">cont_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">wave</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">wave</span><span class="p">))</span>

    <span class="k">return</span>  <span class="n">QTable</span><span class="p">([</span><span class="n">wave</span><span class="p">[</span><span class="n">cont_mask</span><span class="p">],</span><span class="n">flux</span><span class="p">[</span><span class="n">cont_mask</span><span class="p">],</span><span class="n">err</span><span class="p">[</span><span class="n">cont_mask</span><span class="p">]],</span>
                  <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">),</span> <span class="n">masked</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Continuum Spectrum&#39;</span><span class="p">})</span>


</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#now try it out with our G111 data</span>
<span class="c1">#first define the line regions...</span>
<span class="n">g111_line_regions</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">8.88</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span><span class="mf">9.15</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">10.25</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span><span class="mf">10.75</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">]]</span>

<span class="n">g111_cont</span> <span class="o">=</span> <span class="n">createContinuumSpectrum</span><span class="p">(</span><span class="n">g111_clean</span><span class="p">,</span><span class="n">g111_line_regions</span><span class="p">)</span>

<span class="c1">#And plot flux and errors with continuum in green</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">g111_cont</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">],</span><span class="n">g111_cont</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span><span class="n">yerr</span><span class="o">=</span><span class="n">g111_cont</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">],</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Continuum&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;F$_v$ (Jy)&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_LineAnalysis-2_13_0.png" src="_images/FORCAST-Grism_LineAnalysis-2_13_0.png" />
</div>
</div>
<p>Now that we have identified the continuum (plotted in green above), we can use specutils to fit it. specutils utilizes the models and fitters that are part of the astropy.modeling package, so we’ll need to load those too. In the end we’ll save the fitted continuum back in the cleaned data table.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#define a function to fit the continuum; will need to take QTable object as input</span>
<span class="c1">#to support the specutils functions.</span>
<span class="k">def</span> <span class="nf">fitContinuum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">cont</span><span class="p">):</span>
    <span class="c1">#read the wavelength and flux arrays for convenience</span>
    <span class="n">wave</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
    <span class="n">wave_c</span> <span class="o">=</span> <span class="n">cont</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span>
    <span class="n">flux_c</span> <span class="o">=</span> <span class="n">cont</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>

    <span class="c1">#Now load arrays into a Spectrum1D objects for further analysis:</span>
    <span class="c1">#we&#39;ll need one for both the cleaned data and our continuum data:</span>
    <span class="n">spec</span><span class="o">=</span><span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">wave</span><span class="p">,</span><span class="n">flux</span><span class="o">=</span><span class="n">flux</span><span class="p">)</span>
    <span class="n">cont_spec</span><span class="o">=</span><span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">wave_c</span><span class="p">,</span><span class="n">flux</span><span class="o">=</span><span class="n">flux_c</span><span class="p">)</span>

    <span class="c1">#use a 2nd order Chebyshev1D -- see astropy.modeling for more info on using models.</span>
    <span class="n">cont_model</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Chebyshev1D</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">c0</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c1</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c2</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>


    <span class="c1">#Now fit continuum across the grism using fit_generic_continuum</span>
    <span class="c1">#which takes a continuum Spect1D object as input with optional model (which we defined above).</span>
    <span class="n">cont_fit</span><span class="o">=</span><span class="n">fit_generic_continuum</span><span class="p">(</span><span class="n">cont_spec</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">cont_model</span><span class="p">)</span>

    <span class="c1">#and calculate fitted flux values for *full* cleaned spectrum</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;cont&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">cont_fit</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)</span>

    <span class="c1">#Add the continuum fit data to the QTable object.</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#now try it out with our G111 data:</span>
<span class="n">fitContinuum</span><span class="p">(</span><span class="n">g111_clean</span><span class="p">,</span><span class="n">g111_cont</span><span class="p">)</span>

<span class="c1">#and plot model and continuum subtracted flux</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="s1">&#39;b.&#39;</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;total flux&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;cont&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;continuum fit&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;cont&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="s1">&#39;g.&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;continuum subtracted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;F$_v$ (Jy)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: Model is linear in parameters; consider using linear fitting methods. [astropy.modeling.fitting]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_LineAnalysis-2_16_1.png" src="_images/FORCAST-Grism_LineAnalysis-2_16_1.png" />
</div>
</div>
<p>USER EXERCISE: Fit the continuum to the NGC7009 G227 data (see ingredients above), which is slightly larger and more sloped than the G111 continuum.</p>
</section>
<section id="Measuring-Line-Flux">
<h2>Measuring Line Flux<a class="headerlink" href="#Measuring-Line-Flux" title="Permalink to this headline"></a></h2>
<p>The specutils package comes with a number of convenient tools for basic line analysis. This recipe focuses on emission lines, but generally speaking the tools can be used with absorption lines as well. Our first task will be to measure the line flux from the line of interest, in this case, the strong SIV line at 10.5 <span class="math notranslate nohighlight">\(\mu\)</span>m.</p>
<p>We will first load our “clean”-ed continuum-subtracted flux data (along with the errors) into a specutils Spec1D structure and then isolate the line:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">specutils.manipulation</span> <span class="kn">import</span> <span class="n">extract_region</span>

<span class="c1">#First read wavelength, flux, and continuum from our cleaned data table:</span>
<span class="n">wave</span> <span class="o">=</span> <span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span>
<span class="n">flux</span> <span class="o">=</span> <span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;cont&#39;</span><span class="p">]</span>  <span class="c1">#use continuum subtracted flux</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>

<span class="c1">#Now load into Spect1D object:</span>
<span class="n">spec</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">wave</span><span class="p">,</span><span class="n">flux</span><span class="o">=</span><span class="n">flux</span><span class="p">)</span>
<span class="n">err_spec</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">wave</span><span class="p">,</span><span class="n">flux</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>

<span class="c1">#Now define sub region for the 10.5 micron line, just eye-balling from the plot above.</span>
<span class="n">lines_sr</span> <span class="o">=</span> <span class="n">SpectralRegion</span><span class="p">(</span><span class="mf">9.5</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="mf">11.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">)</span>

<span class="c1">#And extract those regions for separate analysis.</span>
<span class="c1">#Extract_region takes a Spect1D and SpectralRegion objects as inputs and returns</span>
<span class="c1">#a *list* of Spect1D objects, one per region.</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">lines_sr</span><span class="p">)</span>
<span class="n">line_errs</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">err_spec</span><span class="p">,</span> <span class="n">lines_sr</span><span class="p">)</span>


<span class="c1">#Plot resulting region surrounding our line:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span><span class="n">lines</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">line_errs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span>
             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;F$_v$ (Jy)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_LineAnalysis-2_19_0.png" src="_images/FORCAST-Grism_LineAnalysis-2_19_0.png" />
</div>
</div>
<p>Now compute the line flux using the built-in function in specutils, which simply integrates under the data. For convenience, we’ll convert the Spec1D objects to frequency space to make the unit conversions easier. Since line_flux is essentially just doing an integration over frequency across the <em>region</em>, we can estimate the 1-<span class="math notranslate nohighlight">\(\sigma\)</span> uncertainty of the line flux by simply adding the flux errors over the region in quadrature and multiplying by the wavelength step.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#convert spec1D objects to frequency space</span>
<span class="c1">#and reverse the arrays b/c apparently specutils expects spectral_axis to be increasing.</span>
<span class="n">tmp</span><span class="o">=</span><span class="n">lines</span><span class="o">.</span><span class="n">spectral_axis</span>
<span class="n">nu</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">THz</span><span class="p">,</span><span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">spectral</span><span class="p">())</span>
<span class="n">lines_nu</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">nu</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">flux</span><span class="o">=</span><span class="n">lines</span><span class="o">.</span><span class="n">flux</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="c1">#And now use the line_flux function to get total line fluxes for the line.</span>
<span class="c1">#line_flux takes a *continuum subtracted* Spectrum1D object with optional spectral region,</span>
<span class="c1">#if the user wants to integrate over a smaller region.</span>
<span class="kn">from</span> <span class="nn">specutils.analysis</span> <span class="kn">import</span> <span class="n">line_flux</span>

<span class="c1">#print lineflux for each line region and convert to W/m^2</span>
<span class="nb">print</span><span class="p">(</span><span class="n">lines_nu</span><span class="p">)</span>  <span class="c1">#Print some info about the line region.</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Line Flux:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">line_flux</span><span class="p">(</span><span class="n">lines_nu</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">line_flux</span><span class="p">(</span><span class="n">lines_nu</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">W</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**-</span><span class="mi">2</span><span class="p">))</span>


<span class="c1">#calculate the errors</span>
<span class="n">errs</span> <span class="o">=</span> <span class="n">line_errs</span><span class="o">.</span><span class="n">flux</span>
<span class="n">quad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">errs</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

<span class="c1">#multiply by the step size in nu, delta_nu.</span>
<span class="c1">#Here I&#39;m simply calculating the average delta_nu across the region:  (nu_max - nu_min)/(N - 1)</span>
<span class="c1">#Where N is the number of samples (points).</span>
<span class="n">nu</span> <span class="o">=</span> <span class="n">lines_nu</span><span class="o">.</span><span class="n">spectral_axis</span>
<span class="n">del_nu</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">line_flux_err</span> <span class="o">=</span> <span class="n">quad</span> <span class="o">*</span> <span class="n">del_nu</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">line_flux_err</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">line_flux_err</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">W</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**-</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SNR:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">line_flux</span><span class="p">(</span><span class="n">lines_nu</span><span class="p">)</span><span class="o">/</span><span class="n">line_flux_err</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;----------------------------&#39;</span><span class="p">)</span>


</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum1D (length=50)
flux:             [ -0.060154 Jy, ..., 0.36707 Jy ],  mean=5.6485 Jy
spectral axis:    [ 27.274 THz, ..., 30.132 THz ],  mean=28.656 THz
Line Flux:
16.355252712734014 Jy THz
1.6355252712734015e-13 W / m2
Error:
0.2786296592121553 Jy THz
2.7862965921215532e-15 W / m2
SNR:
58.69889357428647
----------------------------
</pre></div></div>
</div>
<p>USER EXERCISE: Measure the line flux and SNR for the ArIII line at 9.0 <span class="math notranslate nohighlight">\(\mu\)</span>m.</p>
</section>
<section id="Line-Fitting">
<h2>Line Fitting<a class="headerlink" href="#Line-Fitting" title="Permalink to this headline"></a></h2>
<p>Lastly, specutils provides a nice set of tools for some basic line fitting. Any of the models available in the astropy modelling package can be used. The default fitter is a Levenberg-Marquardt algorithm for least squares (LevMarLSQFitter) although it appears other fitters could be used as well. Evaluating model parameter uncertainties is left to the user. NOTE: Since the grism resolution is R~100 or so, only sources with a significant amount of high velocity emission (&gt;1000 km/s) will really
benefit from line-fitting.</p>
<p>First load the data into the specutils Spec1D objects and extract the line region:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#First read wavelength, flux, and continuum from our cleaned data table:</span>
<span class="n">wave</span> <span class="o">=</span> <span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span>
<span class="n">flux</span> <span class="o">=</span> <span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>   <span class="c1">#observed flux</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>   <span class="c1">#errors</span>
<span class="n">cont</span> <span class="o">=</span> <span class="n">g111_clean</span><span class="p">[</span><span class="s1">&#39;cont&#39;</span><span class="p">]</span>  <span class="c1">#continuum model</span>

<span class="c1">#Now load into Spect1D objects:</span>
<span class="n">spec_obs</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">wave</span><span class="p">,</span><span class="n">flux</span><span class="o">=</span><span class="n">flux</span><span class="p">)</span>
<span class="n">spec_cont</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">wave</span><span class="p">,</span><span class="n">flux</span><span class="o">=</span><span class="n">cont</span><span class="p">)</span>
<span class="n">spec_errs</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">wave</span><span class="p">,</span><span class="n">flux</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>
<span class="n">spec_cs</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">wave</span><span class="p">,</span><span class="n">flux</span><span class="o">=</span><span class="p">(</span><span class="n">flux</span><span class="o">-</span><span class="n">cont</span><span class="p">))</span>  <span class="c1">#we&#39;ll need continuum subtracted flux in the fitting step.</span>

<span class="c1">#Now define sub region for the line at 10.5 micron</span>
<span class="n">line_sr</span> <span class="o">=</span> <span class="n">SpectralRegion</span><span class="p">(</span><span class="mf">9.5</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="mf">11.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">)</span>

<span class="c1">#And extract that region for separate analysis.</span>
<span class="c1">#Extract_region takes a Spect1D and SpectralRegion objects as inputs and returns</span>
<span class="n">line_obs</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">spec_obs</span><span class="p">,</span> <span class="n">line_sr</span><span class="p">)</span>
<span class="n">line_cont</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">spec_cont</span><span class="p">,</span> <span class="n">line_sr</span><span class="p">)</span>
<span class="n">line_err</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">spec_errs</span><span class="p">,</span> <span class="n">line_sr</span><span class="p">)</span>
<span class="n">line_cs</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">spec_cs</span><span class="p">,</span> <span class="n">line_sr</span><span class="p">)</span>   <span class="c1">#continuum subtracted</span>


<span class="c1">#Plot total flux and continuum model:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">line_obs</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span><span class="n">line_obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span>
             <span class="n">yerr</span><span class="o">=</span><span class="n">line_err</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">line_cont</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span><span class="n">line_cont</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;continuum model&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;F$_v$ (Jy)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_LineAnalysis-2_24_0.png" src="_images/FORCAST-Grism_LineAnalysis-2_24_0.png" />
</div>
</div>
<p>Now we’ll load the fitting functions and run the fitter; which is only a few lines of code. Note that a number of profile models are available in the astropy modelling package. Here we’ll use a simple 1D Gaussian:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">specutils.fitting</span> <span class="kn">import</span> <span class="n">fit_lines</span><span class="p">,</span> <span class="n">estimate_line_parameters</span>

<span class="c1">#First generate an initial Gaussian profile model with estimates generated from the data.</span>
<span class="n">g_est</span> <span class="o">=</span> <span class="n">estimate_line_parameters</span><span class="p">(</span><span class="n">line_cs</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">())</span>

<span class="c1">#Numerous other models (e.g. Voigt, Lorentzian, etc...) are available in the</span>
<span class="c1">#astropy modelling package, which can be specified in the estimate_line_parameters call:</span>
<span class="c1">#g_est = estimate_line_parameters(line_cs, models.Voigt1D())</span>
<span class="c1">#g_est = estimate_line_parameters(line_cs, models.Lorentz1D())</span>


<span class="c1">#Regardless of what model is used, the fitting routine is the same.</span>
<span class="c1">#fit_lines takes a Spect1D object and initial model profile as inputs.</span>
<span class="n">g_fit</span> <span class="o">=</span> <span class="n">fit_lines</span><span class="p">(</span><span class="n">line_cs</span><span class="p">,</span> <span class="n">g_est</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">g_fit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model: Gaussian1D
Inputs: (&#39;x&#39;,)
Outputs: (&#39;y&#39;,)
Model set size: 1
Parameters:
       amplitude           mean               stddev
           Jy             micron              micron
    --------------- ------------------ -------------------
    53.866258857508 10.503897458720795 0.04462759099997495
</pre></div></div>
</div>
<p>Next we’ll evaluate the model fluxes at each wavelength and add to the continuum model so we can compare the full model to the observed flux:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Calculate the model line flux and add to continuum model to generate full model:</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">g_fit</span><span class="p">(</span><span class="n">line_cs</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)</span> <span class="o">+</span> <span class="n">line_cont</span><span class="o">.</span><span class="n">flux</span>

<span class="c1">#And calculate fit parameters for display</span>
<span class="n">wave_cent</span><span class="o">=</span><span class="p">[</span><span class="n">g_fit</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
<span class="n">hm</span><span class="o">=</span><span class="p">[</span><span class="n">g_fit</span><span class="o">.</span><span class="n">amplitude</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">]</span>
<span class="n">hwhm</span><span class="o">=</span><span class="p">[</span><span class="mf">2.355</span><span class="o">*</span><span class="n">g_fit</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">]</span>

<span class="c1">#COmpare full model to observed flux</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">line_obs</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span><span class="n">line_obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">line_err</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span>
             <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">line_obs</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;model (cont+line)&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">where</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">)</span>
<span class="c1">#And overplot fitted wavelength and FWHM:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wave_cent</span><span class="p">,</span><span class="n">hm</span><span class="p">,</span><span class="n">xerr</span><span class="o">=</span><span class="n">hwhm</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;FWHM (fit)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;F$_v$ (Jy)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_LineAnalysis-2_28_0.png" src="_images/FORCAST-Grism_LineAnalysis-2_28_0.png" />
</div>
</div>
<p>A sigma of 0.045 <span class="math notranslate nohighlight">\(\mu\)</span>m corresponds to a FWHM of 0.106 <span class="math notranslate nohighlight">\(\mu\)</span>m and an R = v / <span class="math notranslate nohighlight">\(\Delta\)</span>v of about 100, which is close to the R = 130 limit for the G111 grism. The line is either marginally resolved, or the image quality for this particular observation was not quite good enough to achieve the best possible resolution.</p>
<p>We can evaluate the goodness of fit by examining the residuals and calculating the chi-squared and reduced chi-squared statistics. For the degrees of freedom, remember that we used a 2nd order Chebyshev for our continuum, so we have <em>6</em> constraints for the full continuum and line model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Now calculate residuals:</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">line_obs</span><span class="o">.</span><span class="n">flux</span> <span class="o">-</span> <span class="n">model</span>

<span class="c1">#...and plot them.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">line_obs</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">line_err</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;residuals&#39;</span><span class="p">)</span>
<span class="c1">#plt.plot(x.spectral_axis,line_fit,label=&#39;line fit&#39;,color=&#39;red&#39;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Residuals (Jy)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1">#Report the chi**2 statitic (for comparison to other model fits), and the reduced chi-squared:</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1">#nubmer of constraints (parameters) on our continuum + line model.</span>
<span class="n">chisq</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">res</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">line_err</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">chisq_nu</span><span class="o">=</span><span class="n">chisq</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line_obs</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span><span class="o">-</span><span class="n">c</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Chi Squared:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">chisq</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reduced Chi Squared:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">chisq_nu</span><span class="p">)</span>



</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Chi Squared:
302.98749794155054
Reduced Chi Squared:
6.886079498671603
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_LineAnalysis-2_30_1.png" src="_images/FORCAST-Grism_LineAnalysis-2_30_1.png" />
</div>
</div>
<p>While a 1D Gaussian may provide a good estimate of the line centroid and width, it is not a terribly good fit to the observed data. The Voigt profile does not fit very well either: the residuals and chi-squared statistics are nearly identical to those for the Gaussian profile. Detailed modelling of the FORCAST grism line profile is still a work in progress.</p>
<p>USER EXERCISE: Try fitting the SIV line with Voigt and Lorentzian profiles and comapre the results with the Gaussian case.</p>
<p>USER EXERCISE: Find the centroid and FWHM for the ArIII line at 9.9 <span class="math notranslate nohighlight">\(\mu\)</span>m.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="FORCAST-Grism_Inspection-1.html" class="btn btn-neutral float-left" title="FORCAST Grism Spectra: Basic Inspection and Assessment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="FORCAST-Grism_CustomExtraction-3.html" class="btn btn-neutral float-right" title="FORCAST Grism Spectra: Custom Spectral Extraction" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, SOFIA/USRA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>