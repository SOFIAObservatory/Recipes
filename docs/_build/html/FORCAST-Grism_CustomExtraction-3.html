<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FORCAST Grism Spectra: Custom Spectral Extraction &mdash; SOFIA tutorials  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="HAWC+ Data Recipe / 30 Doradus Data Release" href="HAWC_30_Dor.html" />
    <link rel="prev" title="FORCAST Grism Spectra: Basic Line Analysis" href="FORCAST-Grism_LineAnalysis-2.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> SOFIA tutorials
            <img src="_static/sofia_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="SOFIA_data_retrieval.html">SOFIA data retrieval</a></li>
<li class="toctree-l1"><a class="reference internal" href="FORCAST-Basic_Photometry.html">FORCAST Basic photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="FORCAST-photometry_detailed.html">FORCAST photometry (detailed)</a></li>
<li class="toctree-l1"><a class="reference internal" href="FORCAST-Grism_Inspection-1.html">FORCAST Grism Spectra: Basic Inspection and Assessment</a></li>
<li class="toctree-l1"><a class="reference internal" href="FORCAST-Grism_LineAnalysis-2.html">FORCAST Grism Spectra: Basic Line Analysis</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">FORCAST Grism Spectra: Custom Spectral Extraction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Goals">Goals</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Imports">Imports</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Ingredients">Ingredients</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Inspecting-the-Extraction-Aperture">Inspecting the Extraction Aperture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Custom-Extractions">Custom Extractions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="HAWC_30_Dor.html">HAWC+ Data Recipe / 30 Doradus Data Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="EXES-Data-Inspection.html">EXES: Data inspection</a></li>
<li class="toctree-l1"><a class="reference internal" href="pdf_tutorials.html">PDF Tutorials</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SOFIA tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>FORCAST Grism Spectra: Custom Spectral Extraction</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/FORCAST-Grism_CustomExtraction-3.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="FORCAST-Grism-Spectra:-Custom-Spectral-Extraction">
<h1>FORCAST Grism Spectra: Custom Spectral Extraction<a class="headerlink" href="#FORCAST-Grism-Spectra:-Custom-Spectral-Extraction" title="Permalink to this headline"></a></h1>
<ul class="simple">
<li><p><strong>Aim</strong>: Extract grism data with a user-defined aperture.</p></li>
<li><p><strong>Data</strong>: Level 3 grism data of the Saturn Nebula (G111)</p></li>
<li><p><strong>Tools</strong>: astropy, DS9</p></li>
<li><p><strong>Instrument</strong>: FORCAST</p></li>
<li><p><strong>Documentation</strong>: <a class="reference external" href="https://www.sofia.usra.edu/sites/default/files/USpot_DCS_DPS/Documents/FORCAST_data_handbook.pdf">FORCAST data handbook</a></p></li>
<li><p><strong>Notebook repository</strong>: <a class="reference external" href="https://github.com/SOFIAObservatory/Recipes">https://github.com/SOFIAObservatory/Recipes</a></p></li>
</ul>
<section id="Goals">
<h2>Goals<a class="headerlink" href="#Goals" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>Inspect previous aperture extraction</p></li>
<li><p>Determine optimal new extraction based on 2D spectral image</p></li>
<li><p>Plot newly extracted spectrum</p></li>
</ul>
</section>
<section id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this headline"></a></h2>
<p>This recipe provides an overview and sample code (in Python) for custom spectral extractions from the LEVEL_2 2-D rectified images produced by the FORCAST pipeline. We recommend that the user reviews the first FORCAST Grism Recipe (<a class="reference internal" href="FORCAST-Grism_Inspection-1.html"><span class="doc">FORCAST Grism Recipe: Basic Inspection and Assessment</span></a>) before proceeding with this slightly more advanced tutorial.</p>
<p>Raw FORCAST data suffers from several instrumental artifacts. Nearly all of the artifacts are removed or corrected by the FORCAST pipeline, including: bad pixels; the Droop effect; non-linear pixel response; and the “jailbar” effect. In addition, the grism pipeline extracts the one-dimensional spectra, applies both wavelength and flux calibration, and corrects for telluric absorption. For point sources, an “optimal extraction” algorithm is used, while for extended (non-pointlike) sources, a
standard summation over a manually defined aperture is used. See the <a class="reference external" href="https://www.sofia.usra.edu/sites/default/files/USpot_DCS_DPS/Documents/FORCAST_data_handbook.pdf">FORCAST GO Data Handbook</a> for details regarding the artifacts, pipeline algorithms, and the flux-calibration process.</p>
<p>The extraction aperture for extended sources is generally set manually to include all the flux from the source and may not be exactly what the guest investigator (GI) needs for his or her science. For our purposes the extraction aperture is simply the “window” in slit position [x_lo,x_hi] over which flux is summed at each wavelength to produce a 1-D spectrum (flux vs wavelength). The final extracted 1-D spectrum is saved in a CAL file as usual (see <a class="reference internal" href="FORCAST-Grism_Inspection-1.html"><span class="doc">FORCAST Grism Recipe: Basic Inspection and
Assessment</span></a> for review); in addition, the pipeline saves the wavelength-calibrated, recitifeid 2-D spectral image (from which the extraction is made) in a corresponding RIM file, with wavelength along the x-axis and slit position along the y-axis.</p>
<p>In this recipe we show the user how to plot the aperture used on the 2-D spectral image and how to do a simple custom extraction using a different aperture if desired. If a custom extraction is needed, we strongly encourage the GI to contact the <a class="reference external" href="mailto:sofia_help&#37;&#52;&#48;sofia&#46;usra&#46;edu">SOFIA Help Desk</a> and request re-reduction with the specifed aperture(s). This ensures that the GI gets the best quality data using the latest pipeline routines.</p>
</section>
<section id="Imports">
<h2>Imports<a class="headerlink" href="#Imports" title="Permalink to this headline"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>
<span class="kn">from</span> <span class="nn">aplpy</span> <span class="kn">import</span> <span class="n">FITSFigure</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: AstropyDeprecationWarning: block_reduce was moved to the astropy.nddata.blocks module.  Please update your import statement. [astropy.nddata.utils]
</pre></div></div>
</div>
</section>
<section id="Ingredients">
<h2>Ingredients<a class="headerlink" href="#Ingredients" title="Permalink to this headline"></a></h2>
<ol class="arabic simple">
<li><p>Level 3 (flux calibrated) FORCAST grism data (either CAL or CMB files) from the Infrared Science Archive (<a class="reference external" href="https://irsa.ipac.caltech.edu/Missions/sofia.html">IRSA</a>) and the accompanying LEVEL_2 RIM file(s) for each CAL or CMB file.</p>
<ul class="simple">
<li><p>You can obtain the RIM files for a given AOR by using the following search criteria:</p>
<ul>
<li><p>Processing State: Level 2</p></li>
</ul>
</li>
<li><p>The accompanying RIM files will have the same name as the CAL/CMB files, except with “RIM” in the middle of the name instead of “CAL”/“CMB” (see example below).</p></li>
</ul>
</li>
<li><p>Sample Data (if desired): In this example we will be using observations of the PN NGC 7009.</p>
<ul class="simple">
<li><p>Level 3 data can be obtained from the IRSA using the following search criteria:</p>
<ul>
<li><p>Coordinates or Object Name = NGC 7009</p></li>
<li><p>Radius = 100 arcseconds</p></li>
<li><p>Mission ID = “2017-08-07_FO_F428”</p></li>
<li><p>AOR ID = 05_0063_7</p></li>
<li><p>Instrument = FORCAST</p></li>
<li><p>Processing State = Level 3</p></li>
</ul>
</li>
<li><p>Download all data and save to local desktop.</p></li>
<li><p>To get the LEVEL_2 RIM files use the exact same search along with:</p>
<ul>
<li><p>Processing State = “Level 2” And again download all the data and save to local desktop.</p></li>
</ul>
</li>
<li><p>For this example we will be using the following files:</p>
<ul>
<li><p>F0428_FO_GRI_0500637_FORG111_CAL_0177-0196.fits</p></li>
<li><p>F0428_FO_GRI_0500637_FORG111_RIM_0177-0196.fits</p></li>
</ul>
</li>
<li><p><strong>You can download the example data directly</strong><a class="reference external" href="https://zenodo.org/record/5706312/files/FORCAST-Grism_Inspection-example-data.zip?download=1">here</a>.</p></li>
<li><p>For convenience, we recommend saving in a folder called “forcast-sample-data” in the same directory as this Python Notebook.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://www.sofia.usra.edu/sites/default/files/USpot_DCS_DPS/Documents/FORCAST_data_handbook.pdf">FORCAST GO Handbook</a> for reference (latest version can be found on the <a class="reference external" href="https://www.sofia.usra.edu/data/data-processing-0#DataHandbooks">SOFIA Data Products</a> page.)</p></li>
<li><p>Download and install <a class="reference external" href="https://aplpy.github.io/">APLpy</a>.</p></li>
</ol>
</section>
<section id="Inspecting-the-Extraction-Aperture">
<h2>Inspecting the Extraction Aperture<a class="headerlink" href="#Inspecting-the-Extraction-Aperture" title="Permalink to this headline"></a></h2>
<p>Our first task is to determine what aperture was used with the default pipeline extraction and plot it on the 2-D rectified image for evaluation. First load the CAL and RIM files and plot the extracted spectrum from the CAL file:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Define a function for loading fits data into tables with units</span>
<span class="k">def</span> <span class="nf">loadFORCASTGrismData</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1">#Now open fits file for the sample data...</span>
    <span class="n">data_fits</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1">#... read the data portion of the file into a separate array:</span>
    <span class="n">data_tmp</span> <span class="o">=</span> <span class="n">data_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="c1">#... load into table for convenience</span>
    <span class="n">data_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">data_tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data_tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">data_tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">data_tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">data_tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]],</span>
                  <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;telluric&#39;</span><span class="p">,</span> <span class="s1">&#39;response&#39;</span><span class="p">),</span> <span class="n">masked</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Data Table&#39;</span><span class="p">})</span>

    <span class="c1">#and assign units.</span>
    <span class="n">data_table</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;micron&#39;</span>
    <span class="n">data_table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;Jy&#39;</span>
    <span class="n">data_table</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;Jy&#39;</span>
    <span class="n">data_table</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;Jy/s&#39;</span>

    <span class="k">return</span> <span class="n">data_fits</span><span class="p">,</span><span class="n">data_table</span>


<span class="c1">#Calibrated data file on local disk:</span>
<span class="n">calfile</span> <span class="o">=</span> <span class="s1">&#39;../example_data/FORCAST/F0428_FO_GRI_0500637_FORG111_CAL_0177-0196.fits&#39;</span>

<span class="c1">#Load FITS data and tabular data...</span>
<span class="n">g111_fits</span><span class="p">,</span> <span class="n">g111_tab</span><span class="o">=</span><span class="n">loadFORCASTGrismData</span><span class="p">(</span><span class="n">calfile</span><span class="p">)</span>

<span class="c1">#And plot flux and telluric spectra</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;F$_v$ (Jy)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">],</span><span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span><span class="n">yerr</span><span class="o">=</span><span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">],</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Flux&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">)</span>

<span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:red&#39;</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># instantiate a second axes that shares the same x-axis</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Transmission&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">],</span><span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;telluric&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Telluric&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_CustomExtraction-3_7_0.png" src="_images/FORCAST-Grism_CustomExtraction-3_7_0.png" />
</div>
</div>
<p>Now suppose we want to take a look at the 2-D spectral image from which this extraction was made. The recitified 2-D images are stored in the LEVEL_2 “RIM” file (“F0428_FO_GRI_0500637_FORG111_RIM_0177-0196.fits”). The easiest way to quickly read and display this file is to use AplPy (remember that FORCAST image data is stored in 3-D data “cubes” where the first plane is flux):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Load RIM file...</span>
<span class="n">rimfile</span> <span class="o">=</span> <span class="s1">&#39;../example_data/FORCAST/F0428_FO_GRI_0500637_FORG111_RIM_0177-0196.fits&#39;</span>
<span class="n">g111rim_fits</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rimfile</span><span class="p">)</span>

<span class="c1">#And now display 2-d image from RIM file</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;rainbow&#39;</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">FITSFigure</span><span class="p">(</span><span class="n">g111rim_fits</span><span class="p">,</span> <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#0-th slice contains flux</span>
<span class="n">axs</span><span class="o">.</span><span class="n">show_colorscale</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">add_colorbar</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: FITSFixedWarning: &#39;cdfix&#39; made the change &#39;Success&#39;. [astropy.wcs.wcs]
WARNING: FITSFixedWarning: &#39;datfix&#39; made the change &#39;Set MJD-OBS to 57972.428104 from DATE-OBS&#39;. [astropy.wcs.wcs]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
INFO: Auto-setting vmin to -4.027e-03 [aplpy.core]
INFO: Auto-setting vmax to  1.486e-02 [aplpy.core]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_CustomExtraction-3_9_2.png" src="_images/FORCAST-Grism_CustomExtraction-3_9_2.png" />
</div>
</div>
<p>AplPy automatically applies the coordinate transformation matrix (CD matrix) stored in the FITS header to the data, which will make the next step (aperture display) a little easier. So here you can see there appears to be a strong line around 10.6 <span class="math notranslate nohighlight">\(\mu\)</span>m and a weaker one at 9 <span class="math notranslate nohighlight">\(\mu\)</span>m. Since this is clearly not a resolved point source, the user might want to know what aperture was used for the 1-d extraction. The aperture position and radius is stored in the <em>CAL</em> file header using
the FITS keywords “APPOSO01” and “APRADO01” in units of <em>arcsec</em>, so lets grab those values and display them:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Find apertures for G111 extraction, [position (arcsec),radius (arcsec)]</span>
<span class="n">g111_ap</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">g111_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;APPOSO01&#39;</span><span class="p">]),</span>
           <span class="nb">float</span><span class="p">(</span><span class="n">g111_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;APRADO01&#39;</span><span class="p">])]</span>
<span class="nb">print</span><span class="p">,</span><span class="n">g111_ap</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>So the aperture used for the extraction was centered at 120 arcsec with a radius of +/- 20 arcsec, which we can now plot on teh 2-D rectified image:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Display the image again</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;rainbow&#39;</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">FITSFigure</span><span class="p">(</span><span class="n">g111rim_fits</span><span class="p">,</span> <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axs</span><span class="o">.</span><span class="n">show_colorscale</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">add_colorbar</span><span class="p">()</span>

<span class="n">cent</span><span class="o">=</span><span class="n">g111_ap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">rad</span><span class="o">=</span><span class="n">g111_ap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1">#Define center line, and low/hi limits using simple numpy array: [[x1, x2],[y1,y2]]</span>
<span class="n">ap_cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">14</span><span class="p">],[</span><span class="n">cent</span><span class="p">,</span><span class="n">cent</span><span class="p">]])</span>
<span class="n">ap_lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">14</span><span class="p">],[</span><span class="n">cent</span><span class="o">-</span><span class="n">rad</span><span class="p">,</span><span class="n">cent</span><span class="o">-</span><span class="n">rad</span><span class="p">]])</span>
<span class="n">ap_hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">14</span><span class="p">],[</span><span class="n">cent</span><span class="o">+</span><span class="n">rad</span><span class="p">,</span><span class="n">cent</span><span class="o">+</span><span class="n">rad</span><span class="p">]])</span>

<span class="c1">#and now use matplotlib.showlines to overplot the lines on the 2-D image.</span>
<span class="n">axs</span><span class="o">.</span><span class="n">show_lines</span><span class="p">([</span><span class="n">ap_cent</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">show_lines</span><span class="p">([</span><span class="n">ap_lo</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">show_lines</span><span class="p">([</span><span class="n">ap_hi</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: FITSFixedWarning: &#39;cdfix&#39; made the change &#39;Success&#39;. [astropy.wcs.wcs]
WARNING: FITSFixedWarning: &#39;datfix&#39; made the change &#39;Set MJD-OBS to 57972.428104 from DATE-OBS&#39;. [astropy.wcs.wcs]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
INFO: Auto-setting vmin to -3.893e-03 [aplpy.core]
INFO: Auto-setting vmax to  1.544e-02 [aplpy.core]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_CustomExtraction-3_13_2.png" src="_images/FORCAST-Grism_CustomExtraction-3_13_2.png" />
</div>
</div>
</section>
<section id="Custom-Extractions">
<h2>Custom Extractions<a class="headerlink" href="#Custom-Extractions" title="Permalink to this headline"></a></h2>
<p>To make a custom extraction, the user will need the original CAL (or CMB) file (for the telluric and response spectra), the corresponding RIM file, and the size and location of the desired aperture(s). In the example above, the aperture used appears to be a little large and slightly misaligned. We recommend that the user first explore the RIM file using a separate image analysis tool like DS9 in order to identify the exact location and size of the desired apertures. In the case above, using DS9,
we see that the spectral line at ~10.5 <span class="math notranslate nohighlight">\(\mu\)</span>m is double-peaked in the spatial direction:</p>
<img alt="2-D Image" src="_images/ds9_image.png" />
<p>We can also plot flux as a function of slit position for a vertical line-cut along the emission line (see orange line above):</p>
<img alt="Line Plot" src="_images/ds9_plot.png" />
<p>The spatial separation of the two peaks is approximately 10 pixels, which corresponds to ~7.7 arcsec. Since the FWHM of the PSF at 11 <span class="math notranslate nohighlight">\(\mu\)</span>m is typically &lt;3.0 arcsec, this indicates that the two peaks are likely to be real (which might be excpected for a planetary nebula) and we might want to extract spectra for each separately in order to compare the line flux from each position. Using DS9, we estimate the approximate locations and widths of each new aperture (1 and 2) <em>in pixel space</em>:
- Aperture 1 - Center: 162 - Width: 16 - Aperture 2 - Center: 147 - Width: 11</p>
<p>NOTE: Normally we would also identify additional background regions for subtraction. Since the RIM file has already been sky-subtracted, the background is very close to zero and should not make a huge difference in the results of this “quick” extraction.</p>
<p>We will need to first extract the image array from the RIM file. Remember that the RIM data is a data <em>cube</em> containing flux (0), variance (1), and coverage (2). We only need the flux array for this exercise:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Read the data portion of the file into a separate array for convenience.</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">g111rim_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">g111_rim</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span>  <span class="c1">#0th plane contains the flux.</span>
</pre></div>
</div>
</div>
<p>Now define our apertures and plot them on the RIM image.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#original aperture from pipeline reduction as reference.</span>
<span class="c1">#ap0_cent = 150</span>
<span class="c1">#ap0_width = 50</span>

<span class="c1">#Define new apertures:</span>
<span class="n">ap1_cent</span> <span class="o">=</span> <span class="mi">162</span>
<span class="n">ap1_width</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">ap2_cent</span> <span class="o">=</span> <span class="mi">147</span>
<span class="n">ap2_width</span> <span class="o">=</span> <span class="mi">11</span>

<span class="c1">#and convert to integer arrays:</span>
<span class="n">ap1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ap1_cent</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">ap1_width</span><span class="p">,</span><span class="n">ap1_cent</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">ap1_width</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int_&#39;</span><span class="p">)</span>
<span class="n">ap2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ap2_cent</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">ap2_width</span><span class="p">,</span><span class="n">ap2_cent</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">ap2_width</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int_&#39;</span><span class="p">)</span>

<span class="c1"># Create figure and axes</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="c1"># Display the RIM image</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">g111_rim</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>

<span class="c1"># Create a rectangle patch for each aperture:</span>
<span class="n">ap1_patch</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">ap1</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">241</span><span class="p">,</span><span class="n">ap1_width</span><span class="p">,</span>
                             <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<span class="n">ap2_patch</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">ap2</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">241</span><span class="p">,</span><span class="n">ap2_width</span><span class="p">,</span>
                             <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="c1"># Add the patches</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ap1_patch</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ap2_patch</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_CustomExtraction-3_17_0.png" src="_images/FORCAST-Grism_CustomExtraction-3_17_0.png" />
</div>
</div>
<p>Since the 2-D RIM file is already wavelength rectified and calibrated, all we need to do is sum the data in each aperture over the spatial dimension to get the flux at each wavelength in the <em>wavelength array stored in the CAL file</em>. In order to flux calibrate, simply divide by the telluric and response sepctra provided in the CAL file that we loaded earlier in the recipe. Note, however, that for Nod-Match-Chop mode (NMC) the central (positive) source is <em>doubled</em> after stacking, so a factor of
0.5 must be applied to account for this doubling. Most grism observations with FORCAST are taken in NMC mode, but you can confirm by checking the FITS keyword “SKYMODE”.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Sum RIM data over spatial dimension of each aperture,</span>
<span class="c1">#and apply telluric correction and response function to flux calibrate.</span>
<span class="n">flux1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">g111_rim</span><span class="p">[</span><span class="n">ap1</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">ap1</span><span class="p">[</span><span class="mi">1</span><span class="p">],:</span><span class="mi">242</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;telluric&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span>
<span class="n">flux2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">g111_rim</span><span class="p">[</span><span class="n">ap2</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">ap2</span><span class="p">[</span><span class="mi">1</span><span class="p">],:</span><span class="mi">242</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;telluric&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span>

<span class="c1">#If FITS keyword &quot;SKYMODE&quot; =  &quot;NMC&quot;, divide by 2 to account for doubled up central beam.</span>
<span class="k">if</span> <span class="n">g111_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SKYMODE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NMC&#39;</span><span class="p">:</span>
    <span class="n">flux1</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">flux1</span>
    <span class="n">flux2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">flux2</span>

<span class="c1">#Since the wavelength solution in the CAL file is *derived* from the RIM file,</span>
<span class="c1">#we can simply plot the resulting flux arrays for each aperture against the wavelength array</span>
<span class="c1">#in the CAL file.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">],</span> <span class="n">flux1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ap1&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">],</span> <span class="n">flux2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ap2&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="c1">#and plot the default pipeline output for comparison.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">],</span> <span class="n">g111_tab</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pipeline&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;F$_v$ (Jy)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/FORCAST-Grism_CustomExtraction-3_19_0.png" src="_images/FORCAST-Grism_CustomExtraction-3_19_0.png" />
</div>
</div>
<p>We can see from this simple double aperture extraction that the lineflux in the “upper” part of the PN (aperture 1) is about twice that in the “lower” part (aperture 2). This quick extraction method is a good way to explore the data and decide whether a re-reduction should be requested from the SOFIA Science Center. If the user finds that a re-extraction with different aperture(s) is warranted by this quick-look method, we encourage him or her to contact the <a class="reference external" href="mailto:sofia_help&#37;&#52;&#48;sofia&#46;usra&#46;edu">SOFIA Help
Desk</a> with a re-reduction request.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="FORCAST-Grism_LineAnalysis-2.html" class="btn btn-neutral float-left" title="FORCAST Grism Spectra: Basic Line Analysis" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="HAWC_30_Dor.html" class="btn btn-neutral float-right" title="HAWC+ Data Recipe / 30 Doradus Data Release" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, SOFIA/USRA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>